<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>spark-ml-ca-housing | Atma's blog</title>
<link href="../../../../assets/css/all-nocdn.css" rel="stylesheet" type="text/css">
<link href="../../../../assets/css/ipython.min.css" rel="stylesheet" type="text/css">
<link href="../../../../assets/css/nikola_ipython.css" rel="stylesheet" type="text/css">
<meta name="theme-color" content="#d4567b">
<meta name="generator" content="Nikola (getnikola.com)">
<link rel="alternate" type="application/rss+xml" title="RSS" hreflang="en" href="../../../../rss.xml">
<link rel="canonical" href="https://atmamani.github.io/projects/ml/pyspark/spark-ml-ca-housing/">
<link rel="icon" href="../../../../scatter-16.png" sizes="16x16">
<link rel="icon" href="../../../../scatter-32.png" sizes="32x32">
<link rel="icon" href="../../../../scatter-64.png" sizes="64x64">
<link rel="icon" href="../../../../scatter-128.png" sizes="128x128">
<!--[if lt IE 9]><script src="../../../../assets/js/html5.js"></script><![endif]--><!-- Global site tag (gtag.js) - Google Analytics --><script async src="https://www.googletagmanager.com/gtag/js?id=UA-113202945-1"></script><script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-113202945-1');
</script><meta name="author" content="Atma Mani">
<meta property="og:site_name" content="Atma's blog">
<meta property="og:title" content="spark-ml-ca-housing">
<meta property="og:url" content="https://atmamani.github.io/projects/ml/pyspark/spark-ml-ca-housing/">
<meta property="og:description" content="Predicting CA housing prices using SparkMLib¶






Table of Contents
Boiler plate - initialize SparkSession &lt;span class=" amp></head><body><p>&amp; ContextAbout <span class="caps">CA</span> housing datasetPreprocess dataConvert <span class="caps">RDD</span> to Spark DataFrameExploratory d”&gt;
<meta property="og:type" content="article">
<meta property="article:published_time" content="2022-06-08T10:27:44-07:00">

</p>
<a href="#content" class="sr-only sr-only-focusable">Skip to main content</a>

<!-- Menubar -->

<nav class="navbar navbar-inverse navbar-static-top"><div class="container">
<!-- This keeps the margins nice -->
        <div class="navbar-header">
            <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-navbar" aria-controls="bs-navbar" aria-expanded="false">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="https://atmamani.github.io/">

                <span id="blog-title">Atma’s blog</span>
            </a>
        </div>
<!-- /.navbar-header -->
        <div class="collapse navbar-collapse" id="bs-navbar" aria-expanded="false">
            <ul class="nav navbar-nav">
<li class="dropdown">
<a href="#" class="dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">Projects <b class="caret"></b></a>
            <ul class="dropdown-menu">
<li>
<a href="../../../math/">Learn math with Python</a>
                    </li>
<li>
<a href="../../../stats/">Learn stats with Python</a>
                    </li>
<li>
<a href="../../">Machine Learning projects</a>
                    </li>
<li>
<a href="../../../dl/">Deep Learning projects</a>
                    </li>
<li>
<a href="../../../spatial/">Spatial analysis</a>
                    </li>
<li>
<a href="../../../thermal/">Thermal remote sensing</a>
                    </li>
<li>
<a href="../../../mwrs/">Microwave remote sensing</a>
                    </li>
<li>
<a href="../../../cloud/">Cloud computing</a>
                    </li>
<li>
<a href="../../../fun/">Fun projects</a>
            </li>
</ul>
</li>
<li>
<a href="../../../../blog/">Blog</a>
                </li>
<li>
<a href="../../../../talks/">Talks</a>
                </li>
<li>
<a href="../../../../books/">Books</a>
            </li>
<li class="dropdown">
<a href="#" class="dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">Cheatsheets <b class="caret"></b></a>
            <ul class="dropdown-menu">
<li>
<a href="../../../../cheatsheets/learning-resources/">General learning resources</a>
                    </li>
<li>
<a href="../../../../"><hr></a>
                    </li>
<li>
<a href="../../../../cheatsheets/python/python_datatypes/">Python datatypes</a>
                    </li>
<li>
<a href="../../../../cheatsheets/python/python_numeric_datatypes/">Python numeric datatypes</a>
                    </li>
<li>
<a href="../../../../cheatsheets/python/python_conditional_execution/">Python conditional execution</a>
                    </li>
<li>
<a href="../../../../cheatsheets/python/python_functions/">Python functions</a>
                    </li>
<li>
<a href="../../../../cheatsheets/python/python_iterations/">Python iterations</a>
                    </li>
<li>
<a href="../../../../cheatsheets/python/python_exception_handling/">Python exception handling</a>
                    </li>
<li>
<a href="../../../../cheatsheets/python/python_classes/">Python classes</a>
                    </li>
<li>
<a href="../../../../cheatsheets/python/python_memory/">Python memory, ref counts, garbage collection</a>
                    </li>
<li>
<a href="../../../../cheatsheets/python/python_mutability/">Python - mutability and immutability</a>
                    </li>
<li>
<a href="../../../../cheatsheets/python/python_language_optimizations/">Python - language optimizations</a>
                    </li>
<li>
<a href="../../../../images/regex-mindmap.jpg">Python regex</a>
                    </li>
<li>
<a href="../../../../"><hr></a>
                    </li>
<li>
<a href="../../../../cheatsheets/golang/">Go introduction</a>
                    </li>
<li>
<a href="../../../../cheatsheets/golang/golang-basics/">Go basics</a>
                    </li>
<li>
<a href="../../../../cheatsheets/golang/golang-datatypes/">Go data types</a>
                    </li>
<li>
<a href="../../../../cheatsheets/golang/golang-control-flow/">Go control flow</a>
                    </li>
<li>
<a href="../../../../cheatsheets/golang/goroutine/">Goroutines - concurrency in Go lang</a>
                    </li>
<li>
<a href="../../../../"><hr></a>
                    </li>
<li>
<a href="../../../../cheatsheets/conda_cheat_sheet/">Conda basics</a>
                    </li>
<li>
<a href="../../../../cheatsheets/mamba_cheat_sheet/">Mamba basics</a>
                    </li>
<li>
<a href="../../../../"><hr></a>
                    </li>
<li>
<a href="../../../../cheatsheets/numpy/numpy_cheat_sheet_1/">NumPy basics</a>
                    </li>
<li>
<a href="../../../../cheatsheets/numpy/numpy_cheat_sheet_2/">NumPy array slicing, dicing, searching</a>
                    </li>
<li>
<a href="../../../../"><hr></a>
                    </li>
<li>
<a href="../../../../cheatsheets/pandas/pandas_cheat_sheet_1/">Pandas basics</a>
                    </li>
<li>
<a href="../../../../cheatsheets/pandas/pandas_cheat_sheet_2/">Pandas multilevel index, <br>    missing data, aggregation, merging</a>
                    </li>
<li>
<a href="../../../../cheatsheets/pandas/pandas_cheat_sheet_3/">Productivity with Pandas</a>
                    </li>
<li>
<a href="../../../../cheatsheets/pandas/pandas_data_viz_1/">Pandas data visualization</a>
                    </li>
<li>
<a href="../../../../"><hr></a>
                    </li>
<li>
<a href="../../../../cheatsheets/matplotlib/matplotlib_1/">Matplotlib basics</a>
                    </li>
<li>
<a href="../../../../cheatsheets/matplotlib/matplotlib_2/">Matplotlib log scales, ticks, scientific</a>
                    </li>
<li>
<a href="../../../../cheatsheets/matplotlib/matplotlib_geo/">Geographical plotting with Basemap - matplotlib toolkit</a>
                    </li>
<li>
<a href="../../../../"><hr></a>
                    </li>
<li>
<a href="../../../../cheatsheets/seaborn/seaborn_cheat_sheet_1/">Seaborn dist, joint, pair, rug plots</a>
                    </li>
<li>
<a href="../../../../cheatsheets/seaborn/seaborn_cheat_sheet_2/">Seaborn categorical - bar, count, <br>violin, strip, swarm plots</a>
                    </li>
<li>
<a href="../../../../cheatsheets/seaborn/seaborn_cheat_sheet_3/">Seaborn matrix, regression - heatmap, <br> cluster, regression</a>
                    </li>
<li>
<a href="../../../../cheatsheets/seaborn/seaborn_cheat_sheet_4/">Seaborn grids <span class="amp">&amp;</span> custom - pair, facet grids <br> customization</a>
                    </li>
<li>
<a href="../../../../"><hr></a>
                    </li>
<li>
<a href="../../../../cheatsheets/plotly/plotly_cufflinks_cheat_sheet_1/">Plotly introduction</a>
                    </li>
<li>
<a href="../../../../cheatsheets/plotly/plotly_cufflinks_cheat_sheet_2/">Plotly - interactive plotting</a>
                    </li>
<li>
<a href="../../../../cheatsheets/plotly/plotly_geographical_plotting_1/">Plotly - geographic plotting</a>
                    </li>
<li>
<a href="../../../../"><hr></a>
                    </li>
<li>
<a href="../../../../cheatsheets/r_cheat_sheet_1/">R basics</a>
                    </li>
<li>
<a href="../../../../cheatsheets/octave-1/">Octave / <span class="caps">MATLAB</span> - basics</a>
                    </li>
<li>
<a href="../../../../cheatsheets/octave-2/">Octave - handling data</a>
                    </li>
<li>
<a href="../../../../cheatsheets/js_essentials/">Javascript essentials</a>
                    </li>
<li>
<a href="../../../../cheatsheets/latex-1/">Latex introduction</a>
                    </li>
<li>
<a href="../../../../cheatsheets/docker-1/">Docker introduction</a>
                    </li>
<li>
<a href="../../../../cheatsheets/grep-1/">Grep introduction</a>
                    </li>
<li>
<a href="../../../../"><hr></a>
                    </li>
<li>
<a href="../../../../cheatsheets/sql/sql-1"><span class="caps">SQL</span> introduction</a>
                    </li>
<li>
<a href="../../../../cheatsheets/sql/sql-2"><span class="caps">SQL</span> Operators and sorting rows</a>
                    </li>
<li>
<a href="../../../../cheatsheets/sql/sql-3"><span class="caps">SQL</span> Joining tables</a>
                    </li>
<li>
<a href="../../../../cheatsheets/sql/sql-problem-sets-1"><span class="caps">SQL</span> Problem Sets</a>
                    </li>
<li>
<a href="../../../../"><hr></a>
                    </li>
<li>
<a href="../../../../cheatsheets/open-geo/geopandas-1/">GeoPandas - <span class="caps">IO</span>, projections, plotting</a>
                    </li>
<li>
<a href="../../../../cheatsheets/open-geo/geopandas-2/">GeoPandas - <span class="caps">GP</span>, <span class="caps">IO</span>, interactive plotting, geocoding</a>
                    </li>
<li>
<a href="../../../../cheatsheets/open-geo/geopandas-3/">GeoPandas - spatial overlays, topology</a>
                    </li>
<li>
<a href="../../../../cheatsheets/open-geo/geopandas-4/">GeoPandas - PySal, <span class="caps">OSM</span> data <span class="caps">IO</span></a>
                    </li>
<li>
<a href="../../../../cheatsheets/open-geo/open-geo-raster-1/">Rasterio - <span class="caps">IO</span>, plotting, histograms</a>
                    </li>
<li>
<a href="../../../../cheatsheets/open-geo/open-geo-raster-2/">Rasterio - hyperspectral, <span class="caps">SAM</span></a>
                    </li>
<li>
<a href="../../../../cheatsheets/open-geo/reading-multidim-data-using-opengeotools/">Reading multi-dimensional data using open geo tools</a>
                    </li>
<li>
<a href="../../../../cheatsheets/open-geo/postgis-1/">PostGIS - introduction</a>
                    </li>
<li>
<a href="../../../../cheatsheets/open-geo/postgis-2/">PostGIS - SQLAlchemy, GeoAlchemy, GeoPandas</a>
                    </li>
<li>
<a href="../../../../cheatsheets/open-geo/gdal-1/"><span class="caps">GDAL</span> - an introduction</a>
                    </li>
<li>
<a href="../../../../cheatsheets/open-geo/gdal-2/"><span class="caps">GDAL</span> - quickstart</a>
                    </li>
<li>
<a href="../../../../cheatsheets/open-geo/gdal_t1/"><span class="caps">GDAL</span> training day 1</a>
                    </li>
<li>
<a href="../../../../cheatsheets/open-geo/gdal_t2/"><span class="caps">GDAL</span> training day 2</a>
                    </li>
<li>
<a href="../../../../cheatsheets/open-geo/gdal_t3/"><span class="caps">GDAL</span> training day 3</a>
                    </li>
<li>
<a href="../../../../"><hr></a>
                    </li>
<li>
<a href="../../../../cheatsheets/web-development/">Web Development</a>
                    </li>
<li>
<a href="../../../../cheatsheets/html/"><span class="caps">HTML</span> basics</a>
                    </li>
<li>
<a href="../../../../cheatsheets/yaml_syntax/"><span class="caps">YAML</span> Syntax basics</a>
            </li>
</ul>
</li>
<li>
<a href="../../../../apps/">Apps</a>
                </li>
<li>
<a href="../../../../rss.xml"><span class="caps">RSS</span> feed</a>

                
            </li>
</ul>
<!-- DuckDuckGo custom search --><form method="get" id="search" action="https://duckduckgo.com/" class="navbar-form pull-left">
<input type="hidden" name="sites" value="https://atmamani.github.io/"><input type="hidden" name="k8" value="#444444"><input type="hidden" name="k9" value="#D51920"><input type="hidden" name="kt" value="h"><input type="text" name="q" maxlength="255" placeholder="Search…" class="span2" style="margin-top: 4px;"><input type="submit" value="DuckDuckGo Search" style="visibility: hidden;">
</form>
<!-- End of custom search -->


            <ul class="nav navbar-nav navbar-right"></ul>
</div>
<!-- /.navbar-collapse -->
    </div>
<!-- /.container -->
</nav><!-- End of Menubar --><div class="container" id="content" role="main">
    <div class="body-content">
        <!--Body content-->
        <div class="row">
            
            
<article class="post-text storypage" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title" itemprop="headline name"><a href="." class="u-url">spark-ml-ca-housing</a></h1>

        

    </header><div class="e-content entry-content" itemprop="articleBody text">
    <div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Predicting-CA-housing-prices-using-SparkMLib">Predicting <span class="caps">CA</span> housing prices using SparkMLib<a class="anchor-link" href="#Predicting-CA-housing-prices-using-SparkMLib">¶</a>
<a href="#Predicting-CA-housing-prices-using-SparkMLib" class="headerlink" title="Permalink to this heading">¶</a></h2>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p></p>
<h2 id="table-of-contents">Table of Contents<span class="tocSkip"></span>
<a href="#table-of-contents" class="headerlink" title="Permalink to this heading">¶</a></h2>
<div class="toc"><ul class="toc-item">
<li><ul class="toc-item">
<li><span><a href="#Boiler-plate---initialize-SparkSession-&amp;-Context" data-toc-modified-id="Boiler-plate---initialize-SparkSession-&amp;-Context-0.1">Boiler plate - initialize SparkSession <span class="amp">&amp;</span> Context</a></span></li>
<li><span><a href="#About-CA-housing-dataset" data-toc-modified-id="About-CA-housing-dataset-0.2">About <span class="caps">CA</span> housing dataset</a></span></li>
<li><span><a href="#Preprocess-data" data-toc-modified-id="Preprocess-data-0.3">Preprocess data</a></span></li>
<li><span><a href="#Convert-RDD-to-Spark-DataFrame" data-toc-modified-id="Convert-RDD-to-Spark-DataFrame-0.4">Convert <span class="caps">RDD</span> to Spark DataFrame</a></span></li>
<li><span><a href="#Exploratory-data-analysis" data-toc-modified-id="Exploratory-data-analysis-0.5">Exploratory data analysis</a></span></li>
</ul></li>
<li>
<span><a href="#Feature-engineering" data-toc-modified-id="Feature-engineering-1">Feature engineering</a></span><ul class="toc-item"><li><ul class="toc-item">
<li><span><a href="#Re-order-columns-and-split-table-into-label-and-features" data-toc-modified-id="Re-order-columns-and-split-table-into-label-and-features-1.0.1">Re-order columns and split table into label and features</a></span></li>
<li><span><a href="#Scale-data-by-shifting-mean-to-0-and-making-SD-=-1" data-toc-modified-id="Scale-data-by-shifting-mean-to-0-and-making-SD-=-1-1.0.2">Scale data by shifting mean to 0 and making <span class="caps">SD</span> = 1</a></span></li>
</ul></li></ul>
</li>
<li><span><a href="#Split-data-into-training-and-test-sets" data-toc-modified-id="Split-data-into-training-and-test-sets-2">Split data into training and test sets</a></span></li>
<li>
<span><a href="#Perform-Multiple-Regression" data-toc-modified-id="Perform-Multiple-Regression-3">Perform Multiple Regression</a></span><ul class="toc-item">
<li><span><a href="#Inspect-model-properties" data-toc-modified-id="Inspect-model-properties-3.1">Inspect model properties</a></span></li>
<li>
<span><a href="#Perform-predictions" data-toc-modified-id="Perform-predictions-3.2">Perform predictions</a></span><ul class="toc-item">
<li><span><a href="#Regression-evaluator" data-toc-modified-id="Regression-evaluator-3.2.1">Regression evaluator</a></span></li>
<li><span><a href="#Errors---MAE,-RMSE" data-toc-modified-id="Errors---MAE,-RMSE-3.2.2">Errors - <span class="caps">MAE</span>, <span class="caps">RMSE</span></a></span></li>
</ul>
</li>
<li><span><a href="#Compare-training-vs-prediction-errors" data-toc-modified-id="Compare-training-vs-prediction-errors-3.3">Compare training vs prediction errors</a></span></li>
</ul>
</li>
<li>
<span><a href="#Export-data-as-a-Pandas-DataFrame" data-toc-modified-id="Export-data-as-a-Pandas-DataFrame-4">Export data as a Pandas DataFrame</a></span><ul class="toc-item">
<li><span><a href="#Write-to-disk-as-CSV" data-toc-modified-id="Write-to-disk-as-CSV-4.1">Write to disk as <span class="caps">CSV</span></a></span></li>
<li><span><a href="#Publish-to-GIS" data-toc-modified-id="Publish-to-GIS-4.2">Publish to <span class="caps">GIS</span></a></span></li>
<li><span><a href="#Spark-jobs" data-toc-modified-id="Spark-jobs-4.3">Spark jobs</a></span></li>
</ul>
</li>
</ul></div>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h4 id="Boiler-plate---initialize-SparkSession-&amp;-Context">Boiler plate - initialize SparkSession <span class="amp">&amp;</span> Context<a class="anchor-link" href="#Boiler-plate---initialize-SparkSession-&amp;-Context">¶</a>
<a href="#Boiler-plate---initialize-SparkSession-&amp;-Context" class="headerlink" title="Permalink to this heading">¶</a></h4>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In [19]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># Import SparkSession</span>
<span class="kn">from</span> <span class="nn">pyspark.sql</span> <span class="kn">import</span> <span class="n">SparkSession</span>

<span class="c1"># Build the SparkSession</span>
<span class="n">spark</span> <span class="o">=</span> <span class="n">SparkSession</span><span class="o">.</span><span class="n">builder</span> \
   <span class="o">.</span><span class="n">master</span><span class="p">(</span><span class="s2">"local"</span><span class="p">)</span> \
   <span class="o">.</span><span class="n">appName</span><span class="p">(</span><span class="s2">"Linear Regression Model"</span><span class="p">)</span> \
   <span class="o">.</span><span class="n">config</span><span class="p">(</span><span class="s2">"spark.executor.memory"</span><span class="p">,</span> <span class="s2">"1gb"</span><span class="p">)</span> \
   <span class="o">.</span><span class="n">getOrCreate</span><span class="p">()</span>
   
<span class="n">sc</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">sparkContext</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h4 id="About-CA-housing-dataset">About <span class="caps">CA</span> housing dataset<a class="anchor-link" href="#About-CA-housing-dataset">¶</a>
<a href="#About-CA-housing-dataset" class="headerlink" title="Permalink to this heading">¶</a></h4>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Number of records: 20640</p>
<p>variables: Lat, Long, Median Age, #rooms, #bedrooms, population in block, households, med income, med house value</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h4 id="Preprocess-data">Preprocess data<a class="anchor-link" href="#Preprocess-data">¶</a>
<a href="#Preprocess-data" class="headerlink" title="Permalink to this heading">¶</a></h4>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In [4]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="o">!</span>ls ../datasets/CaliforniaHousing/
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area">

    <div class="prompt"></div>


<div class="output_subarea output_stream output_stdout output_text">
<pre>cal_housing.data  cal_housing.domain
</pre>
</div>
</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In [2]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># load data file</span>
<span class="n">rdd</span> <span class="o">=</span> <span class="n">sc</span><span class="o">.</span><span class="n">textFile</span><span class="p">(</span><span class="s1">'../datasets/CaliforniaHousing/cal_housing.data'</span><span class="p">)</span>

<span class="c1"># load header</span>
<span class="n">header</span> <span class="o">=</span> <span class="n">sc</span><span class="o">.</span><span class="n">textFile</span><span class="p">(</span><span class="s1">'../datasets/CaliforniaHousing/cal_housing.domain'</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In [8]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="nb">len</span><span class="p">(</span><span class="n">rdd</span><span class="o">.</span><span class="n">collect</span><span class="p">())</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area">

    <div class="prompt output_prompt">Out[8]:</div>




<div class="output_text output_subarea output_execute_result">
<pre>20640</pre>
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In [10]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="nb">len</span><span class="p">(</span><span class="n">rdd</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="mi">5</span><span class="p">))</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area">

    <div class="prompt output_prompt">Out[10]:</div>




<div class="output_text output_subarea output_execute_result">
<pre>5</pre>
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In [11]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">rdd</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area">

    <div class="prompt output_prompt">Out[11]:</div>




<div class="output_text output_subarea output_execute_result">
<pre>['-122.230000,37.880000,41.000000,880.000000,129.000000,322.000000,126.000000,8.325200,452600.000000',
 '-122.220000,37.860000,21.000000,7099.000000,1106.000000,2401.000000,1138.000000,8.301400,358500.000000',
 '-122.240000,37.850000,52.000000,1467.000000,190.000000,496.000000,177.000000,7.257400,352100.000000',
 '-122.250000,37.850000,52.000000,1274.000000,235.000000,558.000000,219.000000,5.643100,341300.000000',
 '-122.250000,37.850000,52.000000,1627.000000,280.000000,565.000000,259.000000,3.846200,342200.000000']</pre>
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In [3]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># split by comma</span>
<span class="n">rdd</span> <span class="o">=</span> <span class="n">rdd</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">line</span> <span class="p">:</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">','</span><span class="p">))</span>

<span class="c1"># get the first two lines</span>
<span class="n">rdd</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area">

    <div class="prompt output_prompt">Out[3]:</div>




<div class="output_text output_subarea output_execute_result">
<pre>['-122.230000',
 '37.880000',
 '41.000000',
 '880.000000',
 '129.000000',
 '322.000000',
 '126.000000',
 '8.325200',
 '452600.000000']</pre>
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h4 id="Convert-RDD-to-Spark-DataFrame">Convert <span class="caps">RDD</span> to Spark DataFrame<a class="anchor-link" href="#Convert-RDD-to-Spark-DataFrame">¶</a>
<a href="#Convert-RDD-to-Spark-DataFrame" class="headerlink" title="Permalink to this heading">¶</a></h4>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In [4]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># convert RDD to a dataframe</span>
<span class="kn">from</span> <span class="nn">pyspark.sql</span> <span class="kn">import</span> <span class="n">Row</span>

<span class="c1"># Map the RDD to a DF</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">rdd</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">line</span><span class="p">:</span> <span class="n">Row</span><span class="p">(</span><span class="n">longitude</span><span class="o">=</span><span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> 
                              <span class="n">latitude</span><span class="o">=</span><span class="n">line</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> 
                              <span class="n">housingMedianAge</span><span class="o">=</span><span class="n">line</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
                              <span class="n">totalRooms</span><span class="o">=</span><span class="n">line</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span>
                              <span class="n">totalBedRooms</span><span class="o">=</span><span class="n">line</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span>
                              <span class="n">population</span><span class="o">=</span><span class="n">line</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span> 
                              <span class="n">households</span><span class="o">=</span><span class="n">line</span><span class="p">[</span><span class="mi">6</span><span class="p">],</span>
                              <span class="n">medianIncome</span><span class="o">=</span><span class="n">line</span><span class="p">[</span><span class="mi">7</span><span class="p">],</span>
                              <span class="n">medianHouseValue</span><span class="o">=</span><span class="n">line</span><span class="p">[</span><span class="mi">8</span><span class="p">]))</span><span class="o">.</span><span class="n">toDF</span><span class="p">()</span>

<span class="c1"># show the top few DF rows</span>
<span class="n">df</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area">

    <div class="prompt"></div>


<div class="output_subarea output_stream output_stdout output_text">
<pre>+-----------+----------------+---------+-----------+----------------+------------+-----------+-------------+-----------+
| households|housingMedianAge| latitude|  longitude|medianHouseValue|medianIncome| population|totalBedRooms| totalRooms|
+-----------+----------------+---------+-----------+----------------+------------+-----------+-------------+-----------+
| 126.000000|       41.000000|37.880000|-122.230000|   452600.000000|    8.325200| 322.000000|   129.000000| 880.000000|
|1138.000000|       21.000000|37.860000|-122.220000|   358500.000000|    8.301400|2401.000000|  1106.000000|7099.000000|
| 177.000000|       52.000000|37.850000|-122.240000|   352100.000000|    7.257400| 496.000000|   190.000000|1467.000000|
| 219.000000|       52.000000|37.850000|-122.250000|   341300.000000|    5.643100| 558.000000|   235.000000|1274.000000|
| 259.000000|       52.000000|37.850000|-122.250000|   342200.000000|    3.846200| 565.000000|   280.000000|1627.000000|
+-----------+----------------+---------+-----------+----------------+------------+-----------+-------------+-----------+
only showing top 5 rows

</pre>
</div>
</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In [5]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">df</span><span class="o">.</span><span class="n">printSchema</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area">

    <div class="prompt"></div>


<div class="output_subarea output_stream output_stdout output_text">
<pre>root
 |-- households: string (nullable = true)
 |-- housingMedianAge: string (nullable = true)
 |-- latitude: string (nullable = true)
 |-- longitude: string (nullable = true)
 |-- medianHouseValue: string (nullable = true)
 |-- medianIncome: string (nullable = true)
 |-- population: string (nullable = true)
 |-- totalBedRooms: string (nullable = true)
 |-- totalRooms: string (nullable = true)

</pre>
</div>
</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In [6]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># convert all strings to float using a User Defined Function</span>

<span class="kn">from</span> <span class="nn">pyspark.sql.types</span> <span class="kn">import</span> <span class="o">*</span>

<span class="k">def</span> <span class="nf">cast_columns</span><span class="p">(</span><span class="n">df</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">column</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">withColumn</span><span class="p">(</span><span class="n">column</span><span class="p">,</span> <span class="n">df</span><span class="p">[</span><span class="n">column</span><span class="p">]</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">FloatType</span><span class="p">()))</span>
    <span class="k">return</span> <span class="n">df</span>

<span class="n">new_df</span> <span class="o">=</span> <span class="n">cast_columns</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In [7]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">new_df</span><span class="o">.</span><span class="n">show</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area">

    <div class="prompt"></div>


<div class="output_subarea output_stream output_stdout output_text">
<pre>+----------+----------------+--------+---------+----------------+------------+----------+-------------+----------+
|households|housingMedianAge|latitude|longitude|medianHouseValue|medianIncome|population|totalBedRooms|totalRooms|
+----------+----------------+--------+---------+----------------+------------+----------+-------------+----------+
|     126.0|            41.0|   37.88|  -122.23|        452600.0|      8.3252|     322.0|        129.0|     880.0|
|    1138.0|            21.0|   37.86|  -122.22|        358500.0|      8.3014|    2401.0|       1106.0|    7099.0|
+----------+----------------+--------+---------+----------------+------------+----------+-------------+----------+
only showing top 2 rows

</pre>
</div>
</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In [8]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">new_df</span><span class="o">.</span><span class="n">printSchema</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area">

    <div class="prompt"></div>


<div class="output_subarea output_stream output_stdout output_text">
<pre>root
 |-- households: float (nullable = true)
 |-- housingMedianAge: float (nullable = true)
 |-- latitude: float (nullable = true)
 |-- longitude: float (nullable = true)
 |-- medianHouseValue: float (nullable = true)
 |-- medianIncome: float (nullable = true)
 |-- population: float (nullable = true)
 |-- totalBedRooms: float (nullable = true)
 |-- totalRooms: float (nullable = true)

</pre>
</div>
</div>

</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h4 id="Exploratory-data-analysis">Exploratory data analysis<a class="anchor-link" href="#Exploratory-data-analysis">¶</a>
<a href="#Exploratory-data-analysis" class="headerlink" title="Permalink to this heading">¶</a></h4>
<p>Print the summary stats of the table</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In [28]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">new_df</span><span class="o">.</span><span class="n">describe</span><span class="p">()</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area">

    <div class="prompt"></div>


<div class="output_subarea output_stream output_stdout output_text">
<pre>+-------+-----------------+------------------+-----------------+-------------------+------------------+------------------+------------------+-----------------+------------------+
|summary|       households|  housingMedianAge|         latitude|          longitude|  medianHouseValue|      medianIncome|        population|    totalBedRooms|        totalRooms|
+-------+-----------------+------------------+-----------------+-------------------+------------------+------------------+------------------+-----------------+------------------+
|  count|            20640|             20640|            20640|              20640|             20640|             20640|             20640|            20640|             20640|
|   mean|499.5396802325581|28.639486434108527|35.63186143109965|-119.56970444871473|206855.81690891474|3.8706710030346416|1425.4767441860465|537.8980135658915|2635.7630813953488|
| stddev|382.3297528316098| 12.58555761211163|2.135952380602968|  2.003531742932898|115395.61587441359|1.8998217183639696|  1132.46212176534| 421.247905943133|2181.6152515827944|
|    min|              1.0|               1.0|            32.54|            -124.35|           14999.0|            0.4999|               3.0|              1.0|               2.0|
|    max|           6082.0|              52.0|            41.95|            -114.31|          500001.0|           15.0001|           35682.0|           6445.0|           39320.0|
+-------+-----------------+------------------+-----------------+-------------------+------------------+------------------+------------------+-----------------+------------------+

</pre>
</div>
</div>

</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Feature-engineering">Feature engineering<a class="anchor-link" href="#Feature-engineering">¶</a>
<a href="#Feature-engineering" class="headerlink" title="Permalink to this heading">¶</a></h3>
<p>Add more columns such as ‘number of bedrooms per room’, ‘rooms per household’. Also scale the ‘medianHouseValue’ by 1000 so it falls within range of other numbers.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In [ ]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn">pyspark.sql.functions</span> <span class="kn">import</span> <span class="n">col</span>

<span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">withColumn</span><span class="p">(</span><span class="s1">'medianHouseValue'</span><span class="p">,</span> <span class="n">col</span><span class="p">(</span><span class="s1">'medianHouseValue'</span><span class="p">)</span><span class="o">/</span><span class="mi">100000</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In [10]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">df</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area">

    <div class="prompt output_prompt">Out[10]:</div>




<div class="output_text output_subarea output_execute_result">
<pre>Row(households='126.000000', housingMedianAge='41.000000', latitude='37.880000', longitude='-122.230000', medianHouseValue=4.526, medianIncome='8.325200', population='322.000000', totalBedRooms='129.000000', totalRooms='880.000000')</pre>
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In [11]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># add rooms per household</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">withColumn</span><span class="p">(</span><span class="s1">'roomsPerHousehold'</span><span class="p">,</span> <span class="n">col</span><span class="p">(</span><span class="s1">'totalRooms'</span><span class="p">)</span><span class="o">/</span><span class="n">col</span><span class="p">(</span><span class="s1">'households'</span><span class="p">))</span>

<span class="c1"># add population per household (num people in the home)</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">withColumn</span><span class="p">(</span><span class="s1">'popPerHousehold'</span><span class="p">,</span> <span class="n">col</span><span class="p">(</span><span class="s1">'population'</span><span class="p">)</span><span class="o">/</span><span class="n">col</span><span class="p">(</span><span class="s1">'households'</span><span class="p">))</span>

<span class="c1"># add bedrooms per room</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">withColumn</span><span class="p">(</span><span class="s1">'bedroomsPerRoom'</span><span class="p">,</span> <span class="n">col</span><span class="p">(</span><span class="s1">'totalBedRooms'</span><span class="p">)</span><span class="o">/</span><span class="n">col</span><span class="p">(</span><span class="s1">'totalRooms'</span><span class="p">))</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In [12]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">df</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area">

    <div class="prompt output_prompt">Out[12]:</div>




<div class="output_text output_subarea output_execute_result">
<pre>Row(households='126.000000', housingMedianAge='41.000000', latitude='37.880000', longitude='-122.230000', medianHouseValue=4.526, medianIncome='8.325200', population='322.000000', totalBedRooms='129.000000', totalRooms='880.000000', roomsPerHousehold=6.984126984126984, popPerHousehold=2.5555555555555554, bedroomsPerRoom=0.14659090909090908)</pre>
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h5 id="Re-order-columns-and-split-table-into-label-and-features">Re-order columns and split table into label and features<a class="anchor-link" href="#Re-order-columns-and-split-table-into-label-and-features">¶</a>
<a href="#Re-order-columns-and-split-table-into-label-and-features" class="headerlink" title="Permalink to this heading">¶</a></h5>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In [13]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">df</span><span class="o">.</span><span class="n">columns</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area">

    <div class="prompt output_prompt">Out[13]:</div>




<div class="output_text output_subarea output_execute_result">
<pre>['households',
 'housingMedianAge',
 'latitude',
 'longitude',
 'medianHouseValue',
 'medianIncome',
 'population',
 'totalBedRooms',
 'totalRooms',
 'roomsPerHousehold',
 'popPerHousehold',
 'bedroomsPerRoom']</pre>
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In [14]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s1">'medianHouseValue'</span><span class="p">,</span><span class="s1">'households'</span><span class="p">,</span>
 <span class="s1">'housingMedianAge'</span><span class="p">,</span>
 <span class="s1">'latitude'</span><span class="p">,</span>
 <span class="s1">'longitude'</span><span class="p">,</span>
 <span class="s1">'medianIncome'</span><span class="p">,</span>
 <span class="s1">'population'</span><span class="p">,</span>
 <span class="s1">'totalBedRooms'</span><span class="p">,</span>
 <span class="s1">'totalRooms'</span><span class="p">,</span>
 <span class="s1">'roomsPerHousehold'</span><span class="p">,</span>
 <span class="s1">'popPerHousehold'</span><span class="p">,</span>
 <span class="s1">'bedroomsPerRoom'</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Create a new DataFrame that explicitly labels the columns as labels and features. <code>DenseVector</code> is used to temporarily convert the data into numpy array and regroup into a named column DataFrame</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In [15]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn">pyspark.ml.linalg</span> <span class="kn">import</span> <span class="n">DenseVector</span>

<span class="c1"># return a tuple of first column and all other columns</span>
<span class="n">temp_data</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">rdd</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">DenseVector</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">:])))</span>

<span class="c1">#construct back a new DataFrame</span>
<span class="n">df2</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">createDataFrame</span><span class="p">(</span><span class="n">temp_data</span><span class="p">,</span> <span class="p">[</span><span class="s1">'label'</span><span class="p">,</span><span class="s1">'features'</span><span class="p">])</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In [16]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">df2</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area">

    <div class="prompt output_prompt">Out[16]:</div>




<div class="output_text output_subarea output_execute_result">
<pre>[Row(label=4.526, features=DenseVector([126.0, 41.0, 37.88, -122.23, 8.3252, 322.0, 129.0, 880.0, 6.9841, 2.5556, 0.1466])),
 Row(label=3.585, features=DenseVector([1138.0, 21.0, 37.86, -122.22, 8.3014, 2401.0, 1106.0, 7099.0, 6.2381, 2.1098, 0.1558]))]</pre>
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h5 id="Scale-data-by-shifting-mean-to-0-and-making-SD-=-1">Scale data by shifting mean to 0 and making <span class="caps">SD</span> = 1<a class="anchor-link" href="#Scale-data-by-shifting-mean-to-0-and-making-SD-=-1">¶</a>
<a href="#Scale-data-by-shifting-mean-to-0-and-making-SD-=-1" class="headerlink" title="Permalink to this heading">¶</a></h5>
<p>This ensures all columns have similar levels of variability</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In [17]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># use StandardScaler to scale the features to std normal distribution</span>
<span class="kn">from</span> <span class="nn">pyspark.ml.feature</span> <span class="kn">import</span> <span class="n">StandardScaler</span>

<span class="n">s_scaler_model</span> <span class="o">=</span> <span class="n">StandardScaler</span><span class="p">(</span><span class="n">inputCol</span><span class="o">=</span><span class="s1">'features'</span><span class="p">,</span> <span class="n">outputCol</span><span class="o">=</span><span class="s1">'features_scaled'</span><span class="p">)</span>
<span class="n">scaler_fn</span> <span class="o">=</span> <span class="n">s_scaler_model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">df2</span><span class="p">)</span>
<span class="n">scaled_df</span> <span class="o">=</span> <span class="n">scaler_fn</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">df2</span><span class="p">)</span>

<span class="n">scaled_df</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area">

    <div class="prompt output_prompt">Out[17]:</div>




<div class="output_text output_subarea output_execute_result">
<pre>[Row(label=4.526, features=DenseVector([126.0, 41.0, 37.88, -122.23, 8.3252, 322.0, 129.0, 880.0, 6.9841, 2.5556, 0.1466]), features_scaled=DenseVector([0.3296, 3.2577, 17.7345, -61.0073, 4.3821, 0.2843, 0.3062, 0.4034, 2.8228, 0.2461, 2.5264])),
 Row(label=3.585, features=DenseVector([1138.0, 21.0, 37.86, -122.22, 8.3014, 2401.0, 1106.0, 7099.0, 6.2381, 2.1098, 0.1558]), features_scaled=DenseVector([2.9765, 1.6686, 17.7251, -61.0023, 4.3696, 2.1202, 2.6255, 3.254, 2.5213, 0.2031, 2.6851]))]</pre>
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Split-data-into-training-and-test-sets">Split data into training and test sets<a class="anchor-link" href="#Split-data-into-training-and-test-sets">¶</a>
<a href="#Split-data-into-training-and-test-sets" class="headerlink" title="Permalink to this heading">¶</a></h3>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In [18]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">train_data</span><span class="p">,</span> <span class="n">test_data</span> <span class="o">=</span> <span class="n">scaled_df</span><span class="o">.</span><span class="n">randomSplit</span><span class="p">([</span><span class="mf">.8</span><span class="p">,</span><span class="mf">.2</span><span class="p">],</span> <span class="n">seed</span><span class="o">=</span><span class="mi">101</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In [19]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="nb">type</span><span class="p">(</span><span class="n">train_data</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area">

    <div class="prompt output_prompt">Out[19]:</div>




<div class="output_text output_subarea output_execute_result">
<pre>pyspark.sql.dataframe.DataFrame</pre>
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Perform-Multiple-Regression">Perform Multiple Regression<a class="anchor-link" href="#Perform-Multiple-Regression">¶</a>
<a href="#Perform-Multiple-Regression" class="headerlink" title="Permalink to this heading">¶</a></h3>
<p>Train the model</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In [21]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn">pyspark.ml.regression</span> <span class="kn">import</span> <span class="n">LinearRegression</span>

<span class="n">lr</span> <span class="o">=</span> <span class="n">LinearRegression</span><span class="p">(</span><span class="n">labelCol</span><span class="o">=</span><span class="s1">'label'</span><span class="p">,</span> <span class="n">maxIter</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>

<span class="n">linear_model</span> <span class="o">=</span> <span class="n">lr</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">train_data</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h4 id="Inspect-model-properties">Inspect model properties<a class="anchor-link" href="#Inspect-model-properties">¶</a>
<a href="#Inspect-model-properties" class="headerlink" title="Permalink to this heading">¶</a></h4>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In [22]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="nb">type</span><span class="p">(</span><span class="n">linear_model</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area">

    <div class="prompt output_prompt">Out[22]:</div>




<div class="output_text output_subarea output_execute_result">
<pre>pyspark.ml.regression.LinearRegressionModel</pre>
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In [23]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">linear_model</span><span class="o">.</span><span class="n">coefficients</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area">

    <div class="prompt output_prompt">Out[23]:</div>




<div class="output_text output_subarea output_execute_result">
<pre>DenseVector([0.0011, 0.0109, -0.4173, -0.4236, 0.4188, -0.0005, 0.0001, 0.0, 0.0275, 0.0012, 3.2844])</pre>
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Print columns and their coefficients</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In [39]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span> <span class="n">linear_model</span><span class="o">.</span><span class="n">coefficients</span><span class="p">))</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area">

    <div class="prompt output_prompt">Out[39]:</div>




<div class="output_text output_subarea output_execute_result">
<pre>[('households', 0.0011435392550412861),
 ('housingMedianAge', 0.010914556934928758),
 ('latitude', -0.41728655702892636),
 ('longitude', -0.42357898833074664),
 ('medianIncome', 0.41879550542755656),
 ('population', -0.00047200983464106163),
 ('totalBedRooms', 0.00011060741530102377),
 ('totalRooms', 4.099208155268924e-05),
 ('roomsPerHousehold', 0.027483252262545631),
 ('popPerHousehold', 0.0011993665224223444),
 ('bedroomsPerRoom', 3.2844476401153044)]</pre>
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In [28]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">linear_model</span><span class="o">.</span><span class="n">intercept</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area">

    <div class="prompt output_prompt">Out[28]:</div>




<div class="output_text output_subarea output_execute_result">
<pre>-36.56273436779799</pre>
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In [31]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">linear_model</span><span class="o">.</span><span class="n">summary</span><span class="o">.</span><span class="n">numInstances</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area">

    <div class="prompt output_prompt">Out[31]:</div>




<div class="output_text output_subarea output_execute_result">
<pre>16535</pre>
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p><span class="caps">MAE</span> from training data</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In [35]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">linear_model</span><span class="o">.</span><span class="n">summary</span><span class="o">.</span><span class="n">meanAbsoluteError</span> <span class="o">*</span> <span class="mi">100000</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area">

    <div class="prompt output_prompt">Out[35]:</div>




<div class="output_text output_subarea output_execute_result">
<pre>49805.60256405839</pre>
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Thus, <span class="caps">MAE</span> on training data is off by $50,000</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In [34]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">linear_model</span><span class="o">.</span><span class="n">summary</span><span class="o">.</span><span class="n">meanSquaredError</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area">

    <div class="prompt output_prompt">Out[34]:</div>




<div class="output_text output_subarea output_execute_result">
<pre>0.46775402314782377</pre>
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In [45]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">linear_model</span><span class="o">.</span><span class="n">summary</span><span class="o">.</span><span class="n">rootMeanSquaredError</span> <span class="o">*</span> <span class="mi">100000</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area">

    <div class="prompt output_prompt">Out[45]:</div>




<div class="output_text output_subarea output_execute_result">
<pre>68392.54514549255</pre>
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Thus, <span class="caps">RMSE</span> shows fitting on training data is off by $68,392</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In [40]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span> <span class="n">linear_model</span><span class="o">.</span><span class="n">summary</span><span class="o">.</span><span class="n">pValues</span><span class="p">))</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area">

    <div class="prompt output_prompt">Out[40]:</div>




<div class="output_text output_subarea output_execute_result">
<pre>[('households', 0.0),
 ('housingMedianAge', 0.0),
 ('latitude', 0.0),
 ('longitude', 0.0),
 ('medianIncome', 0.0),
 ('population', 0.0),
 ('totalBedRooms', 0.2242631044109853),
 ('totalRooms', 0.00010585023878628697),
 ('roomsPerHousehold', 0.0),
 ('popPerHousehold', 0.011952235555041435),
 ('bedroomsPerRoom', 0.0)]</pre>
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h4 id="Perform-predictions">Perform predictions<a class="anchor-link" href="#Perform-predictions">¶</a>
<a href="#Perform-predictions" class="headerlink" title="Permalink to this heading">¶</a></h4>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In [41]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">predicted</span> <span class="o">=</span> <span class="n">linear_model</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">test_data</span><span class="p">)</span>
<span class="n">predicted</span><span class="o">.</span><span class="n">columns</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area">

    <div class="prompt output_prompt">Out[41]:</div>




<div class="output_text output_subarea output_execute_result">
<pre>['label', 'features', 'features_scaled', 'prediction']</pre>
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In [43]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="nb">type</span><span class="p">(</span><span class="n">predicted</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area">

    <div class="prompt output_prompt">Out[43]:</div>




<div class="output_text output_subarea output_execute_result">
<pre>pyspark.sql.dataframe.DataFrame</pre>
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In [47]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">test_predictions</span> <span class="o">=</span> <span class="n">predicted</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s1">'prediction'</span><span class="p">)</span><span class="o">.</span><span class="n">rdd</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="n">test_labels</span> <span class="o">=</span> <span class="n">predicted</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s1">'label'</span><span class="p">)</span><span class="o">.</span><span class="n">rdd</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

<span class="n">test_predictions_labels</span> <span class="o">=</span> <span class="n">test_predictions</span><span class="o">.</span><span class="n">zip</span><span class="p">(</span><span class="n">test_labels</span><span class="p">)</span>
<span class="n">test_predictions_labels_df</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">createDataFrame</span><span class="p">(</span><span class="n">test_predictions_labels</span><span class="p">,</span> 
                                                   <span class="p">[</span><span class="s1">'predictions'</span><span class="p">,</span><span class="s1">'labels'</span><span class="p">])</span>

<span class="n">test_predictions_labels_df</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area">

    <div class="prompt output_prompt">Out[47]:</div>




<div class="output_text output_subarea output_execute_result">
<pre>[Row(predictions=1.8357791571765532, labels=0.225),
 Row(predictions=-0.9555783395577535, labels=0.225)]</pre>
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h5 id="Regression-evaluator">Regression evaluator<a class="anchor-link" href="#Regression-evaluator">¶</a>
<a href="#Regression-evaluator" class="headerlink" title="Permalink to this heading">¶</a></h5>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In [49]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn">pyspark.ml.evaluation</span> <span class="kn">import</span> <span class="n">RegressionEvaluator</span>

<span class="n">linear_reg_eval</span> <span class="o">=</span> <span class="n">RegressionEvaluator</span><span class="p">(</span><span class="n">predictionCol</span><span class="o">=</span><span class="s1">'predictions'</span><span class="p">,</span> <span class="n">labelCol</span><span class="o">=</span><span class="s1">'labels'</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In [50]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">linear_reg_eval</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">test_predictions_labels_df</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area">

    <div class="prompt output_prompt">Out[50]:</div>




<div class="output_text output_subarea output_execute_result">
<pre>0.6962295496358668</pre>
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h5 id="Errors---MAE,-RMSE">Errors - <span class="caps">MAE</span>, <span class="caps">RMSE</span><a class="anchor-link" href="#Errors---MAE,-RMSE">¶</a>
<a href="#Errors---MAE,-RMSE" class="headerlink" title="Permalink to this heading">¶</a></h5>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In [58]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># mean absolute error</span>
<span class="n">prediction_mae</span> <span class="o">=</span> <span class="n">linear_reg_eval</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">test_predictions_labels_df</span><span class="p">,</span> 
                                          <span class="p">{</span><span class="n">linear_reg_eval</span><span class="o">.</span><span class="n">metricName</span><span class="p">:</span><span class="s1">'mae'</span><span class="p">})</span> <span class="o">*</span> <span class="mi">100000</span>
<span class="n">prediction_mae</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area">

    <div class="prompt output_prompt">Out[58]:</div>




<div class="output_text output_subarea output_execute_result">
<pre>49690.440586665725</pre>
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In [59]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># RMSE</span>
<span class="n">prediction_rmse</span> <span class="o">=</span> <span class="n">linear_reg_eval</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">test_predictions_labels_df</span><span class="p">,</span> 
                                           <span class="p">{</span><span class="n">linear_reg_eval</span><span class="o">.</span><span class="n">metricName</span><span class="p">:</span><span class="s1">'rmse'</span><span class="p">})</span> <span class="o">*</span> <span class="mi">100000</span>

<span class="n">prediction_rmse</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area">

    <div class="prompt output_prompt">Out[59]:</div>




<div class="output_text output_subarea output_execute_result">
<pre>69622.95496358669</pre>
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h4 id="Compare-training-vs-prediction-errors">Compare training vs prediction errors<a class="anchor-link" href="#Compare-training-vs-prediction-errors">¶</a>
<a href="#Compare-training-vs-prediction-errors" class="headerlink" title="Permalink to this heading">¶</a></h4>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In [60]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="s1">'(training error, prediction error)'</span><span class="p">)</span>
<span class="nb">print</span><span class="p">((</span><span class="n">linear_model</span><span class="o">.</span><span class="n">summary</span><span class="o">.</span><span class="n">rootMeanSquaredError</span> <span class="o">*</span> <span class="mi">100000</span><span class="p">,</span> <span class="n">prediction_rmse</span><span class="p">))</span>
<span class="nb">print</span><span class="p">((</span><span class="n">linear_model</span><span class="o">.</span><span class="n">summary</span><span class="o">.</span><span class="n">meanAbsoluteError</span> <span class="o">*</span> <span class="mi">100000</span><span class="p">,</span> <span class="n">prediction_mae</span><span class="p">))</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area">

    <div class="prompt"></div>


<div class="output_subarea output_stream output_stdout output_text">
<pre>(training error, prediction error)
(68392.54514549255, 69622.95496358669)
(49805.60256405839, 49690.440586665725)
</pre>
</div>
</div>

</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Export-data-as-a-Pandas-DataFrame">Export data as a Pandas DataFrame<a class="anchor-link" href="#Export-data-as-a-Pandas-DataFrame">¶</a>
<a href="#Export-data-as-a-Pandas-DataFrame" class="headerlink" title="Permalink to this heading">¶</a></h3>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In [61]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">predicted_pandas_df</span> <span class="o">=</span> <span class="n">predicted</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="s1">'features'</span><span class="p">,</span><span class="s1">'prediction'</span><span class="p">)</span><span class="o">.</span><span class="n">toPandas</span><span class="p">()</span>
<span class="n">predicted_pandas_df</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area">

    <div class="prompt output_prompt">Out[61]:</div>



<div class="output_html rendered_html output_subarea output_execute_result"><div>
<style>
    .dataframe thead tr:only-child th {
        text-align: right;
    }

    .dataframe thead th {
        text-align: left;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }
</style>
<table border="1" class="dataframe">
<thead><tr style="text-align: right;">
<th></th>
      <th>features</th>
      <th>prediction</th>
    </tr></thead>
<tbody>
<tr>
<th>0</th>
      <td>[63.0, 33.0, 37.93, -122.32, 2.675, 216.0, 73….</td>
      <td>1.835779</td>
    </tr>
<tr>
<th>1</th>
      <td>[1439.0, 8.0, 35.43, -116.57, 2.7138, 6835.0, …</td>
      <td>-0.955578</td>
    </tr>
<tr>
<th>2</th>
      <td>[15.0, 17.0, 33.92, -114.67, 1.2656, 29.0, 24….</td>
      <td>-0.426930</td>
    </tr>
<tr>
<th>3</th>
      <td>[288.0, 20.0, 38.56, -121.36, 1.8288, 667.0, 3…</td>
      <td>0.843599</td>
    </tr>
<tr>
<th>4</th>
      <td>[382.0, 52.0, 37.78, -122.41, 1.8519, 1055.0, …</td>
      <td>2.335877</td>
    </tr>
</tbody>
</table>
</div></div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In [62]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">predicted_pandas_df</span><span class="o">.</span><span class="n">columns</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area">

    <div class="prompt output_prompt">Out[62]:</div>




<div class="output_text output_subarea output_execute_result">
<pre>Index(['features', 'prediction'], dtype='object')</pre>
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In [65]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="n">predicted_pandas_df2</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">predicted_pandas_df</span><span class="p">[</span><span class="s1">'features'</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span> 
                                   <span class="n">columns</span><span class="o">=</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>

<span class="n">predicted_pandas_df2</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area">

    <div class="prompt output_prompt">Out[65]:</div>



<div class="output_html rendered_html output_subarea output_execute_result"><div>
<style>
    .dataframe thead tr:only-child th {
        text-align: right;
    }

    .dataframe thead th {
        text-align: left;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }
</style>
<table border="1" class="dataframe">
<thead><tr style="text-align: right;">
<th></th>
      <th>households</th>
      <th>housingMedianAge</th>
      <th>latitude</th>
      <th>longitude</th>
      <th>medianIncome</th>
      <th>population</th>
      <th>totalBedRooms</th>
      <th>totalRooms</th>
      <th>roomsPerHousehold</th>
      <th>popPerHousehold</th>
      <th>bedroomsPerRoom</th>
    </tr></thead>
<tbody>
<tr>
<th>0</th>
      <td>63.0</td>
      <td>33.0</td>
      <td>37.93</td>
      <td>-122.32</td>
      <td>2.6750</td>
      <td>216.0</td>
      <td>73.0</td>
      <td>296.0</td>
      <td>4.698413</td>
      <td>3.428571</td>
      <td>0.246622</td>
    </tr>
<tr>
<th>1</th>
      <td>1439.0</td>
      <td>8.0</td>
      <td>35.43</td>
      <td>-116.57</td>
      <td>2.7138</td>
      <td>6835.0</td>
      <td>1743.0</td>
      <td>9975.0</td>
      <td>6.931897</td>
      <td>4.749826</td>
      <td>0.174737</td>
    </tr>
<tr>
<th>2</th>
      <td>15.0</td>
      <td>17.0</td>
      <td>33.92</td>
      <td>-114.67</td>
      <td>1.2656</td>
      <td>29.0</td>
      <td>24.0</td>
      <td>97.0</td>
      <td>6.466667</td>
      <td>1.933333</td>
      <td>0.247423</td>
    </tr>
<tr>
<th>3</th>
      <td>288.0</td>
      <td>20.0</td>
      <td>38.56</td>
      <td>-121.36</td>
      <td>1.8288</td>
      <td>667.0</td>
      <td>332.0</td>
      <td>1232.0</td>
      <td>4.277778</td>
      <td>2.315972</td>
      <td>0.269481</td>
    </tr>
<tr>
<th>4</th>
      <td>382.0</td>
      <td>52.0</td>
      <td>37.78</td>
      <td>-122.41</td>
      <td>1.8519</td>
      <td>1055.0</td>
      <td>422.0</td>
      <td>1014.0</td>
      <td>2.654450</td>
      <td>2.761780</td>
      <td>0.416174</td>
    </tr>
</tbody>
</table>
</div></div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In [66]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">predicted_pandas_df2</span><span class="p">[</span><span class="s1">'predictedHouseValue'</span><span class="p">]</span> <span class="o">=</span> <span class="n">predicted_pandas_df</span><span class="p">[</span><span class="s1">'prediction'</span><span class="p">]</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h4 id="Write-to-disk-as-CSV">Write to disk as <span class="caps">CSV</span><a class="anchor-link" href="#Write-to-disk-as-CSV">¶</a>
<a href="#Write-to-disk-as-CSV" class="headerlink" title="Permalink to this heading">¶</a></h4>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In [67]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">predicted_pandas_df2</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="s1">'CA_house_prices_predicted.csv'</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In [68]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="o">!</span>ls
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area">

    <div class="prompt"></div>


<div class="output_subarea output_stream output_stdout output_text">
<pre>CA_house_prices_predicted.csv  spark_sanity.ipynb
ensure_machine.ipynb	       spark-warehouse
hello-world.ipynb	       Untitled.ipynb
spark-ml-CA-housing.ipynb      using-spark-dataframes.ipynb
</pre>
</div>
</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In [69]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">predicted_pandas_df2</span><span class="o">.</span><span class="n">shape</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area">

    <div class="prompt output_prompt">Out[69]:</div>




<div class="output_text output_subarea output_execute_result">
<pre>(4105, 12)</pre>
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h4 id="Publish-to-GIS">Publish to <span class="caps">GIS</span><a class="anchor-link" href="#Publish-to-GIS">¶</a>
<a href="#Publish-to-GIS" class="headerlink" title="Permalink to this heading">¶</a></h4>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In [9]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">from</span> <span class="nn">arcgis.gis</span> <span class="kn">import</span> <span class="n">GIS</span>
<span class="n">gis</span> <span class="o">=</span> <span class="n">GIS</span><span class="p">(</span><span class="s2">"https://www.arcgis.com"</span><span class="p">,</span><span class="s2">"arcgis_python"</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area">

    <div class="prompt"></div>


<div class="output_subarea output_stream output_stdout output_text">
<pre>Enter password: ········
</pre>
</div>
</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In [3]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn">arcgis.features</span> <span class="kn">import</span> <span class="n">SpatialDataFrame</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In [4]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">sdf</span> <span class="o">=</span> <span class="n">SpatialDataFrame</span><span class="o">.</span><span class="n">from_csv</span><span class="p">(</span><span class="s1">'CA_house_prices_predicted.csv'</span><span class="p">)</span>
<span class="n">sdf</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area">

    <div class="prompt output_prompt">Out[4]:</div>



<div class="output_html rendered_html output_subarea output_execute_result"><div>
<style>
    .dataframe thead tr:only-child th {
        text-align: right;
    }

    .dataframe thead th {
        text-align: left;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }
</style>
<table border="1" class="dataframe">
<thead><tr style="text-align: right;">
<th></th>
      <th>households</th>
      <th>housingMedianAge</th>
      <th>latitude</th>
      <th>longitude</th>
      <th>medianIncome</th>
      <th>population</th>
      <th>totalBedRooms</th>
      <th>totalRooms</th>
      <th>roomsPerHousehold</th>
      <th>popPerHousehold</th>
      <th>bedroomsPerRoom</th>
      <th>predictedHouseValue</th>
    </tr></thead>
<tbody>
<tr>
<th>0</th>
      <td>63.0</td>
      <td>33.0</td>
      <td>37.93</td>
      <td>-122.32</td>
      <td>2.6750</td>
      <td>216.0</td>
      <td>73.0</td>
      <td>296.0</td>
      <td>4.698413</td>
      <td>3.428571</td>
      <td>0.246622</td>
      <td>1.835779</td>
    </tr>
<tr>
<th>1</th>
      <td>1439.0</td>
      <td>8.0</td>
      <td>35.43</td>
      <td>-116.57</td>
      <td>2.7138</td>
      <td>6835.0</td>
      <td>1743.0</td>
      <td>9975.0</td>
      <td>6.931897</td>
      <td>4.749826</td>
      <td>0.174737</td>
      <td>-0.955578</td>
    </tr>
<tr>
<th>2</th>
      <td>15.0</td>
      <td>17.0</td>
      <td>33.92</td>
      <td>-114.67</td>
      <td>1.2656</td>
      <td>29.0</td>
      <td>24.0</td>
      <td>97.0</td>
      <td>6.466667</td>
      <td>1.933333</td>
      <td>0.247423</td>
      <td>-0.426930</td>
    </tr>
<tr>
<th>3</th>
      <td>288.0</td>
      <td>20.0</td>
      <td>38.56</td>
      <td>-121.36</td>
      <td>1.8288</td>
      <td>667.0</td>
      <td>332.0</td>
      <td>1232.0</td>
      <td>4.277778</td>
      <td>2.315972</td>
      <td>0.269481</td>
      <td>0.843599</td>
    </tr>
<tr>
<th>4</th>
      <td>382.0</td>
      <td>52.0</td>
      <td>37.78</td>
      <td>-122.41</td>
      <td>1.8519</td>
      <td>1055.0</td>
      <td>422.0</td>
      <td>1014.0</td>
      <td>2.654450</td>
      <td>2.761780</td>
      <td>0.416174</td>
      <td>2.335877</td>
    </tr>
</tbody>
</table>
</div></div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In [11]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">houses_predicted_fc</span> <span class="o">=</span> <span class="n">gis</span><span class="o">.</span><span class="n">content</span><span class="o">.</span><span class="n">import_data</span><span class="p">(</span><span class="n">sdf</span><span class="p">[:</span><span class="mi">999</span><span class="p">])</span>
<span class="n">houses_predicted_fc</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area">

    <div class="prompt output_prompt">Out[11]:</div>




<div class="output_text output_subarea output_execute_result">
<pre>&lt;FeatureCollection&gt;</pre>
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In [14]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">ca_map</span> <span class="o">=</span> <span class="n">gis</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="s1">'California'</span><span class="p">)</span>
<span class="n">ca_map</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area">

    <div class="prompt"></div>





</div>

</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p><img src="../../../../images/ca-house-price-map.png" alt=""></p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In [18]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">ca_map</span><span class="o">.</span><span class="n">add_layer</span><span class="p">(</span><span class="n">houses_predicted_fc</span><span class="p">,</span> <span class="p">{</span><span class="s1">'renderer'</span><span class="p">:</span><span class="s1">'ClassedColorRenderer'</span><span class="p">,</span>
                                      <span class="s1">'field_name'</span><span class="p">:</span><span class="s1">'predictedHouseValue'</span><span class="p">})</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area">

    <div class="prompt"></div>


<div class="output_subarea output_stream output_stdout output_text">
<pre> 
</pre>
</div>
</div>

</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h4 id="Spark-jobs">Spark jobs<a class="anchor-link" href="#Spark-jobs">¶</a>
<a href="#Spark-jobs" class="headerlink" title="Permalink to this heading">¶</a></h4>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p><img src="../../../../images/spark-active-job-1.png" alt=""></p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p><img src="../../../../images/spark-timeline-1.png" alt=""></p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In [ ]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span> 
</pre></div>

    </div>
</div>
</div>

</div>
    </div>
    
        
        <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-AMS-MML_HTMLorMML" integrity="sha384-3lJUsx1TJHt7BA4udB5KPnDrlkO8T6J6v/op7ui0BbCjvZ9WqV4Xm6DTP6kQ/iBH" crossorigin="anonymous"></script><script type="text/x-mathjax-config">
MathJax.Hub.Config({
    tex2jax: {
        inlineMath: [ ['$','$'], ["\\(","\\)"] ],
        displayMath: [ ['$$','$$'], ["\\[","\\]"] ],
        processEscapes: true
    },
    displayAlign: 'center', // Change this to 'left' if you want left-aligned equations.
    "HTML-CSS": {
        styles: {'.MathJax_Display': {"margin": 0}}
    }
});
</script></article>
</div>
        <!--End of body content-->

        <footer id="footer">
            Contents © 2023         <a href="mailto:atma.mani@outlook.com">Atma Mani</a> - Powered by         <a href="https://getnikola.com" rel="nofollow">Nikola</a>         
            
        </footer>
</div>
</div>


            <script src="../../../../assets/js/all-nocdn.js"></script><!-- fancy dates --><script>
    moment.locale("en");
    fancydates(0, "YYYY-MM-DD HH:mm");
    </script><!-- end fancy dates --><script>
    baguetteBox.run('div#content', {
        ignoreClass: 'islink',
        captions: function(element) {
            return element.getElementsByTagName('img')[0].alt;
    }});
    </script>

</body></html>