<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Deep Learning on imagery using `fastai.vision` module | Atma's blog</title>
<link href="../../../../assets/css/all-nocdn.css" rel="stylesheet" type="text/css">
<link href="../../../../assets/css/ipython.min.css" rel="stylesheet" type="text/css">
<link href="../../../../assets/css/nikola_ipython.css" rel="stylesheet" type="text/css">
<meta name="theme-color" content="#d4567b">
<meta name="generator" content="Nikola (getnikola.com)">
<link rel="alternate" type="application/rss+xml" title="RSS" hreflang="en" href="../../../../rss.xml">
<link rel="canonical" href="https://atmamani.github.io/projects/dl/fastai/vision/">
<link rel="icon" href="../../../../scatter-16.png" sizes="16x16">
<link rel="icon" href="../../../../scatter-32.png" sizes="32x32">
<link rel="icon" href="../../../../scatter-64.png" sizes="64x64">
<link rel="icon" href="../../../../scatter-128.png" sizes="128x128">
<!--[if lt IE 9]><script src="../../../../assets/js/html5.js"></script><![endif]--><!-- Global site tag (gtag.js) - Google Analytics --><script async src="https://www.googletagmanager.com/gtag/js?id=UA-113202945-1"></script><script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-113202945-1');
</script><meta name="author" content="Atma Mani">
<meta property="og:site_name" content="Atma's blog">
<meta property="og:title" content="Deep Learning on imagery using `fastai.vision` module">
<meta property="og:url" content="https://atmamani.github.io/projects/dl/fastai/vision/">
<meta property="og:description" content="List of relevant functions and classes
Getting sample data

fastai.datasets contains a set of curated datasets that sits on S3. You can get the list from fastai.datasets.URLs
URLs.PETS for example wil">
<meta property="og:type" content="article">
<meta property="article:published_time" content="2022-06-08T10:27:44-07:00">
</head>
<body>
<a href="#content" class="sr-only sr-only-focusable">Skip to main content</a>

<!-- Menubar -->

<nav class="navbar navbar-inverse navbar-static-top"><div class="container">
<!-- This keeps the margins nice -->
        <div class="navbar-header">
            <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-navbar" aria-controls="bs-navbar" aria-expanded="false">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="https://atmamani.github.io/">

                <span id="blog-title">Atma’s blog</span>
            </a>
        </div>
<!-- /.navbar-header -->
        <div class="collapse navbar-collapse" id="bs-navbar" aria-expanded="false">
            <ul class="nav navbar-nav">
<li class="dropdown">
<a href="#" class="dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">Projects <b class="caret"></b></a>
            <ul class="dropdown-menu">
<li>
<a href="../../../math/">Learn math with Python</a>
                    </li>
<li>
<a href="../../../stats/">Learn stats with Python</a>
                    </li>
<li>
<a href="../../../ml/">Machine Learning projects</a>
                    </li>
<li>
<a href="../../">Deep Learning projects</a>
                    </li>
<li>
<a href="../../../spatial/">Spatial analysis</a>
                    </li>
<li>
<a href="../../../thermal/">Thermal remote sensing</a>
                    </li>
<li>
<a href="../../../mwrs/">Microwave remote sensing</a>
                    </li>
<li>
<a href="../../../cloud/">Cloud computing</a>
                    </li>
<li>
<a href="../../../fun/">Fun projects</a>
            </li>
</ul>
</li>
<li>
<a href="../../../../blog/">Blog</a>
                </li>
<li>
<a href="../../../../talks/">Talks</a>
                </li>
<li>
<a href="../../../../books/">Books</a>
            </li>
<li class="dropdown">
<a href="#" class="dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">Cheatsheets <b class="caret"></b></a>
            <ul class="dropdown-menu">
<li>
<a href="../../../../cheatsheets/learning-resources/">General learning resources</a>
                    </li>
<li>
<a href="../../../../"><hr></a>
                    </li>
<li>
<a href="../../../../cheatsheets/python/python_datatypes/">Python datatypes</a>
                    </li>
<li>
<a href="../../../../cheatsheets/python/python_numeric_datatypes/">Python numeric datatypes</a>
                    </li>
<li>
<a href="../../../../cheatsheets/python/python_conditional_execution/">Python conditional execution</a>
                    </li>
<li>
<a href="../../../../cheatsheets/python/python_functions/">Python functions</a>
                    </li>
<li>
<a href="../../../../cheatsheets/python/python_iterations/">Python iterations</a>
                    </li>
<li>
<a href="../../../../cheatsheets/python/python_exception_handling/">Python exception handling</a>
                    </li>
<li>
<a href="../../../../cheatsheets/python/python_classes/">Python classes</a>
                    </li>
<li>
<a href="../../../../cheatsheets/python/python_memory/">Python memory, ref counts, garbage collection</a>
                    </li>
<li>
<a href="../../../../cheatsheets/python/python_mutability/">Python - mutability and immutability</a>
                    </li>
<li>
<a href="../../../../cheatsheets/python/python_language_optimizations/">Python - language optimizations</a>
                    </li>
<li>
<a href="../../../../images/regex-mindmap.jpg">Python regex</a>
                    </li>
<li>
<a href="../../../../"><hr></a>
                    </li>
<li>
<a href="../../../../cheatsheets/golang/">Go introduction</a>
                    </li>
<li>
<a href="../../../../cheatsheets/golang/golang-basics/">Go basics</a>
                    </li>
<li>
<a href="../../../../cheatsheets/golang/golang-datatypes/">Go data types</a>
                    </li>
<li>
<a href="../../../../cheatsheets/golang/golang-control-flow/">Go control flow</a>
                    </li>
<li>
<a href="../../../../cheatsheets/golang/goroutine/">Goroutines - concurrency in Go lang</a>
                    </li>
<li>
<a href="../../../../"><hr></a>
                    </li>
<li>
<a href="../../../../cheatsheets/conda_cheat_sheet/">Conda basics</a>
                    </li>
<li>
<a href="../../../../cheatsheets/mamba_cheat_sheet/">Mamba basics</a>
                    </li>
<li>
<a href="../../../../"><hr></a>
                    </li>
<li>
<a href="../../../../cheatsheets/numpy/numpy_cheat_sheet_1/">NumPy basics</a>
                    </li>
<li>
<a href="../../../../cheatsheets/numpy/numpy_cheat_sheet_2/">NumPy array slicing, dicing, searching</a>
                    </li>
<li>
<a href="../../../../"><hr></a>
                    </li>
<li>
<a href="../../../../cheatsheets/pandas/pandas_cheat_sheet_1/">Pandas basics</a>
                    </li>
<li>
<a href="../../../../cheatsheets/pandas/pandas_cheat_sheet_2/">Pandas multilevel index, <br>    missing data, aggregation, merging</a>
                    </li>
<li>
<a href="../../../../cheatsheets/pandas/pandas_cheat_sheet_3/">Productivity with Pandas</a>
                    </li>
<li>
<a href="../../../../cheatsheets/pandas/pandas_data_viz_1/">Pandas data visualization</a>
                    </li>
<li>
<a href="../../../../"><hr></a>
                    </li>
<li>
<a href="../../../../cheatsheets/matplotlib/matplotlib_1/">Matplotlib basics</a>
                    </li>
<li>
<a href="../../../../cheatsheets/matplotlib/matplotlib_2/">Matplotlib log scales, ticks, scientific</a>
                    </li>
<li>
<a href="../../../../cheatsheets/matplotlib/matplotlib_geo/">Geographical plotting with Basemap - matplotlib toolkit</a>
                    </li>
<li>
<a href="../../../../"><hr></a>
                    </li>
<li>
<a href="../../../../cheatsheets/seaborn/seaborn_cheat_sheet_1/">Seaborn dist, joint, pair, rug plots</a>
                    </li>
<li>
<a href="../../../../cheatsheets/seaborn/seaborn_cheat_sheet_2/">Seaborn categorical - bar, count, <br>violin, strip, swarm plots</a>
                    </li>
<li>
<a href="../../../../cheatsheets/seaborn/seaborn_cheat_sheet_3/">Seaborn matrix, regression - heatmap, <br> cluster, regression</a>
                    </li>
<li>
<a href="../../../../cheatsheets/seaborn/seaborn_cheat_sheet_4/">Seaborn grids <span class="amp">&amp;</span> custom - pair, facet grids <br> customization</a>
                    </li>
<li>
<a href="../../../../"><hr></a>
                    </li>
<li>
<a href="../../../../cheatsheets/plotly/plotly_cufflinks_cheat_sheet_1/">Plotly introduction</a>
                    </li>
<li>
<a href="../../../../cheatsheets/plotly/plotly_cufflinks_cheat_sheet_2/">Plotly - interactive plotting</a>
                    </li>
<li>
<a href="../../../../cheatsheets/plotly/plotly_geographical_plotting_1/">Plotly - geographic plotting</a>
                    </li>
<li>
<a href="../../../../"><hr></a>
                    </li>
<li>
<a href="../../../../cheatsheets/r_cheat_sheet_1/">R basics</a>
                    </li>
<li>
<a href="../../../../cheatsheets/octave-1/">Octave / <span class="caps">MATLAB</span> - basics</a>
                    </li>
<li>
<a href="../../../../cheatsheets/octave-2/">Octave - handling data</a>
                    </li>
<li>
<a href="../../../../cheatsheets/js_essentials/">Javascript essentials</a>
                    </li>
<li>
<a href="../../../../cheatsheets/latex-1/">Latex introduction</a>
                    </li>
<li>
<a href="../../../../cheatsheets/docker-1/">Docker introduction</a>
                    </li>
<li>
<a href="../../../../cheatsheets/grep-1/">Grep introduction</a>
                    </li>
<li>
<a href="../../../../"><hr></a>
                    </li>
<li>
<a href="../../../../cheatsheets/sql/sql-1"><span class="caps">SQL</span> introduction</a>
                    </li>
<li>
<a href="../../../../cheatsheets/sql/sql-2"><span class="caps">SQL</span> Queries</a>
                    </li>
<li>
<a href="../../../../"><hr></a>
                    </li>
<li>
<a href="../../../../cheatsheets/open-geo/geopandas-1/">GeoPandas - <span class="caps">IO</span>, projections, plotting</a>
                    </li>
<li>
<a href="../../../../cheatsheets/open-geo/geopandas-2/">GeoPandas - <span class="caps">GP</span>, <span class="caps">IO</span>, interactive plotting, geocoding</a>
                    </li>
<li>
<a href="../../../../cheatsheets/open-geo/geopandas-3/">GeoPandas - spatial overlays, topology</a>
                    </li>
<li>
<a href="../../../../cheatsheets/open-geo/geopandas-4/">GeoPandas - PySal, <span class="caps">OSM</span> data <span class="caps">IO</span></a>
                    </li>
<li>
<a href="../../../../cheatsheets/open-geo/open-geo-raster-1/">Rasterio - <span class="caps">IO</span>, plotting, histograms</a>
                    </li>
<li>
<a href="../../../../cheatsheets/open-geo/open-geo-raster-2/">Rasterio - hyperspectral, <span class="caps">SAM</span></a>
                    </li>
<li>
<a href="../../../../cheatsheets/open-geo/reading-multidim-data-using-opengeotools/">Reading multi-dimensional data using open geo tools</a>
                    </li>
<li>
<a href="../../../../cheatsheets/open-geo/postgis-1/">PostGIS - introduction</a>
                    </li>
<li>
<a href="../../../../cheatsheets/open-geo/postgis-2/">PostGIS - SQLAlchemy, GeoAlchemy, GeoPandas</a>
                    </li>
<li>
<a href="../../../../cheatsheets/open-geo/gdal-1/"><span class="caps">GDAL</span> - an introduction</a>
                    </li>
<li>
<a href="../../../../cheatsheets/open-geo/gdal-2/"><span class="caps">GDAL</span> - quickstart</a>
                    </li>
<li>
<a href="../../../../cheatsheets/open-geo/gdal_t1/"><span class="caps">GDAL</span> training day 1</a>
                    </li>
<li>
<a href="../../../../cheatsheets/open-geo/gdal_t2/"><span class="caps">GDAL</span> training day 2</a>
                    </li>
<li>
<a href="../../../../cheatsheets/open-geo/gdal_t3/"><span class="caps">GDAL</span> training day 3</a>
                    </li>
<li>
<a href="../../../../"><hr></a>
                    </li>
<li>
<a href="../../../../cheatsheets/web-development/">Web Development</a>
                    </li>
<li>
<a href="../../../../cheatsheets/html/"><span class="caps">HTML</span> basics</a>
                    </li>
<li>
<a href="../../../../cheatsheets/yaml_syntax/"><span class="caps">YAML</span> Syntax basics</a>
            </li>
</ul>
</li>
<li>
<a href="../../../../apps/">Apps</a>
                </li>
<li>
<a href="../../../../rss.xml"><span class="caps">RSS</span> feed</a>

                
            </li>
</ul>
<!-- DuckDuckGo custom search --><form method="get" id="search" action="https://duckduckgo.com/" class="navbar-form pull-left">
<input type="hidden" name="sites" value="https://atmamani.github.io/"><input type="hidden" name="k8" value="#444444"><input type="hidden" name="k9" value="#D51920"><input type="hidden" name="kt" value="h"><input type="text" name="q" maxlength="255" placeholder="Search…" class="span2" style="margin-top: 4px;"><input type="submit" value="DuckDuckGo Search" style="visibility: hidden;">
</form>
<!-- End of custom search -->


            <ul class="nav navbar-nav navbar-right"></ul>
</div>
<!-- /.navbar-collapse -->
    </div>
<!-- /.container -->
</nav><!-- End of Menubar --><div class="container" id="content" role="main">
    <div class="body-content">
        <!--Body content-->
        <div class="row">
            
            
<article class="post-text storypage" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title" itemprop="headline name"><a href="." class="u-url">Deep Learning on imagery using `fastai.vision` module</a></h1>

        

    </header><div class="e-content entry-content" itemprop="articleBody text">
    <h3 id="list-of-relevant-functions-and-classes">List of relevant functions and classes<a href="#list-of-relevant-functions-and-classes" class="headerlink" title="Permalink to this heading">¶</a></h3>
<h4 id="getting-sample-data">Getting sample data<a href="#getting-sample-data" class="headerlink" title="Permalink to this heading">¶</a></h4>
<ul>
<li>
<code>fastai.datasets</code> contains a set of curated datasets that sits on S3. You can get the list from <code>fastai.datasets.URLs</code>
</li>
<li>
<code>URLs.PETS</code> for example will return the download <span class="caps">URL</span>.</li>
<li>
<code>fastai.datasets.untar_data()</code> will download to a <code>.fastai/data</code> folder under local user data and will return that path as a <code>Pathlib.Path</code> object</li>
</ul>
<h4 id="loading-image-data">Loading image data<a href="#loading-image-data" class="headerlink" title="Permalink to this heading">¶</a></h4>
<ul>
<li>
<code>fastai.vision.data.get_image_files()</code> will scan a directory of image files and return a list of <code>Path</code> objects.</li>
<li>The next step is to create an <strong><code>ImageDataBunch</code></strong> instance. In FastAI, <code>DataBunch</code> objects form the main way to represent and hold training and test datasets.</li>
<li>
<strong><code>fastai.vision.data.ImageDataBunch.from_name_re()</code></strong> is a static, factory method allows you to construct an <code>ImageDataBunch</code> and while doing that, it can extract labels from file names. It accepts a Python Regular Expression syntax for this. You also feed it with transformations, size to resize and batch size the <span class="caps">GPU</span> can handle. See example below:</li>
</ul>
<div class="code"><pre class="code literal-block"><span class="n">pat</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">'/([^/]+)_\d+.jpg$'</span>
<span class="n">data</span> <span class="o">=</span> <span class="n">ImageDataBunch</span><span class="o">.</span><span class="n">from_name_re</span><span class="p">(</span><span class="n">path_img</span><span class="p">,</span> <span class="n">fnames</span><span class="p">,</span> <span class="n">pat</span><span class="p">,</span> <span class="n">ds_tfms</span><span class="o">=</span><span class="n">get_transforms</span><span class="p">(),</span> <span class="n">size</span><span class="o">=</span><span class="mi">224</span><span class="p">,</span> <span class="n">bs</span><span class="o">=</span><span class="n">bs</span><span class="p">)</span>
<span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">normalize</span><span class="p">(</span><span class="n">imagenet_stats</span><span class="p">)</span>
</pre></div>

<ul>
<li>
<code>fastai.vision.transform.get_transforms()</code> is a utility func that is used to specify and get back a list of transformation that need to applied on the DataBunch object.</li>
<li>The <code>from_name_re()</code> will split the data into training and validation sets. These can be accessed via <code>data.valid_ds</code> and <code>data.train_ds</code> where, <code>data</code> is instance of <code>ImageDataBunch</code>.</li>
<li>
<code>data.show_batch()</code> can be used to display training data in a notebook.</li>
<li>
<code>data.classes</code> will return the label classes it has parsed using the regular expression earlier.</li>
<li>
<code>data.batch_size</code> shows the batch size configured</li>
</ul>
<h5 id="different-ways-of-loading-data-into-databunch-objects">Different ways of loading data into DataBunch objects<a href="#different-ways-of-loading-data-into-databunch-objects" class="headerlink" title="Permalink to this heading">¶</a></h5>
<ul>
<li>
<code>data = ImageDataBunch.from_folder(path, ds_tfms, size)</code> can create it from folder, sub-folder structure</li>
<li>
<code>data = ImageDataBunch.from_csv(path, ds_tfms, size)</code> can load it from a <span class="caps">CSV</span> containing file names and class values</li>
<li>
<code>data = ImageDataBunch.from_df(path, df, ds_tfms, size)</code> can load data from a df</li>
<li>
<code>data = ImageDataBunch.from_name_func(path, fn_paths, ds_tfms, size, label_func= lambda x:'3' if '/3/' in str(x) else '7')</code> to create from an anonymous function</li>
<li>
<code>data = ImageDataBunch.from_lists(path, fn_paths, labels, ds_tfms, size)</code> to create from a list of class values.</li>
</ul>
<h4 id="training">Training<a href="#training" class="headerlink" title="Permalink to this heading">¶</a></h4>
<ul>
<li>
<code>fastai.vision.models</code> module can list all models that are supported. For instance, <code>[mdl for mdl in dir(fastai.vision.models) if '__' not in mdl]</code> list comp will return <code>40</code> such models as of 2021.</li>
</ul>
<div class="code"><pre class="code literal-block"><span class="kn">from</span> <span class="nn">pprint</span> <span class="kn">import</span> <span class="n">pprint</span>
<span class="n">pprint</span><span class="p">([</span><span class="n">mdl</span> <span class="k">for</span> <span class="n">mdl</span> <span class="ow">in</span> <span class="nb">dir</span><span class="p">(</span><span class="n">fastai</span><span class="o">.</span><span class="n">vision</span><span class="o">.</span><span class="n">models</span><span class="p">)</span> <span class="k">if</span> <span class="s1">'__'</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">mdl</span><span class="p">],</span> <span class="n">compact</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="o">&gt;&gt;&gt;</span> <span class="p">[</span><span class="s1">'BasicBlock'</span><span class="p">,</span> <span class="s1">'Darknet'</span><span class="p">,</span> <span class="s1">'DynamicUnet'</span><span class="p">,</span> <span class="s1">'ResLayer'</span><span class="p">,</span> <span class="s1">'ResNet'</span><span class="p">,</span> <span class="s1">'SqueezeNet'</span><span class="p">,</span>
 <span class="s1">'UnetBlock'</span><span class="p">,</span> <span class="s1">'WideResNet'</span><span class="p">,</span> <span class="s1">'XResNet'</span><span class="p">,</span> <span class="s1">'alexnet'</span><span class="p">,</span> <span class="s1">'darknet'</span><span class="p">,</span> <span class="s1">'densenet121'</span><span class="p">,</span>
 <span class="s1">'densenet161'</span><span class="p">,</span> <span class="s1">'densenet169'</span><span class="p">,</span> <span class="s1">'densenet201'</span><span class="p">,</span> <span class="s1">'mobilenet_v2'</span><span class="p">,</span> <span class="s1">'resnet101'</span><span class="p">,</span>
 <span class="s1">'resnet152'</span><span class="p">,</span> <span class="s1">'resnet18'</span><span class="p">,</span> <span class="s1">'resnet34'</span><span class="p">,</span> <span class="s1">'resnet50'</span><span class="p">,</span> <span class="s1">'squeezenet1_0'</span><span class="p">,</span>
 <span class="s1">'squeezenet1_1'</span><span class="p">,</span> <span class="s1">'unet'</span><span class="p">,</span> <span class="s1">'vgg11_bn'</span><span class="p">,</span> <span class="s1">'vgg13_bn'</span><span class="p">,</span> <span class="s1">'vgg16_bn'</span><span class="p">,</span> <span class="s1">'vgg19_bn'</span><span class="p">,</span> <span class="s1">'wrn'</span><span class="p">,</span>
 <span class="s1">'wrn_22'</span><span class="p">,</span> <span class="s1">'xception'</span><span class="p">,</span> <span class="s1">'xresnet'</span><span class="p">,</span> <span class="s1">'xresnet101'</span><span class="p">,</span> <span class="s1">'xresnet152'</span><span class="p">,</span> <span class="s1">'xresnet18'</span><span class="p">,</span>
 <span class="s1">'xresnet18_deep'</span><span class="p">,</span> <span class="s1">'xresnet34'</span><span class="p">,</span> <span class="s1">'xresnet34_deep'</span><span class="p">,</span> <span class="s1">'xresnet50'</span><span class="p">,</span>
 <span class="s1">'xresnet50_deep'</span><span class="p">]</span>
<span class="mi">40</span>
</pre></div>

<ul>
<li>
<code>fastai.metrics.error_rate()</code> is a type of loss function, we use in training on images</li>
<li>
<strong><code>fastai.vision.learner.cnn_learner()</code></strong> is a static, factory method that creates a convolutional neural network based on the backbone and loss function specified. For instance, <code>learn = cnn_learner(data, models.resnet34, metrics=error_rate)</code>.<ul>
<li>Note, when creating the learner, you pass the whole data bunch - <strong>including both training and test data</strong>.</li>
<li>The <code>error_rate</code> function will help in evaluating the performance on both the training data as well as the validation data.</li>
</ul>
</li>
<li>
<strong><code>learn.fit_one_cycle(cyc_len=4)</code></strong> is used to train the <code>restnet34</code> model. The cycle length parameter determines how many times to repeat the one cycle learning. The output of this cell shows the following:</li>
</ul>
<div class="code"><pre class="code literal-block">epoch   train_loss  valid_loss  error_rate  time
0       1.361700    0.337071    0.104195    02:24
1       0.601790    0.297722    0.089310    02:07
2       0.380089    0.282888    0.079838    02:26
3       0.271350    0.246164    0.071719    02:07

Wall time: 9min 6s
</pre></div>

<ul>
<li>The output above shows at end of epoch 4, we have an error rate of <code>0.071</code> which means about <code>92.9%</code> accuracy.</li>
<li>Calling <code>learn.summary()</code> returns you a high level info on each of the layers in the <span class="caps">DL</span> model along with summary info at the end.</li>
<li>Finally, <strong>save the model</strong> by calling <code>learn.save(file='pets-lesson01-stage1', return_path=True)</code> which will return the path to the model file on disk, such as: <code>PosixPath('/Users/atma6951/.fastai/data/oxford-iiit-pet/images/models/pets-lesson01-stage-1.pth)</code> and weighs about <code>90 MB</code> in size. By default, Fastai tries to keep the models in the same location as the data bunch.</li>
</ul>
<h4 id="model-accuracy">Model accuracy<a href="#model-accuracy" class="headerlink" title="Permalink to this heading">¶</a></h4>
<p>Once training is complete, you can use the following tools to evaluate the accuracy.</p>
<ul>
<li>Use <code>interp = fastai.train.ClassificationInterpretation.from_learner(learn)</code> to create an instance of <code>ClassificationInterpretation</code> class. Running this takes a while as fastai will compute the accuracy of each of the result in the validation dataset.</li>
<li>
<code>interp.top_losses()</code> will return a tuple of losses and indices which correspond to loss value and index of that dataset in the <code>data.valid_ds</code> bunch. Since the function sorts the data by descending loss value, it supplies the index to match with original dataset.</li>
<li>
<code>interp.plot_top_losses(k=9, figsize=(7,7))</code> will plot the top losses in a matrix along with the <code>predicted / actual / loss / probability</code> values as annotations.</li>
<li>
<code>interp.plot_confusion_matrix(figsize=(16,16))</code> will plot the seaborn style confusion matrix with heatmap. For a <code>37</code> class problem like the pets, this matrix gets hard to read. When num classes is high and accuracy is also generally high, use,</li>
<li>
<code>interp.most_confused(min_val=2)</code> will return a list of tuples - containing <code>prediction, actual, num_confusions</code>. The <code>min_val=2</code> tells the <span class="caps">API</span> to ignore cases where just <code>1</code> file is misclassified. It is essentially, the descending order of non-diagonal cells in the confusion matrix.</li>
</ul>
<h4 id="model-fine-tuning">Model fine-tuning<a href="#model-fine-tuning" class="headerlink" title="Permalink to this heading">¶</a></h4>
<p>So far, the <code>fit_one_cycle()</code> method was used on <code>4</code> epochs and the training went fairly quickly (<code>10</code> mins). This is because, the <code>cnn_learner()</code> produced a model that is based on <code>resnet32</code> and added a few layers to the end. The <code>fit_one_cycle()</code> trained only those last few layers and left most of the earlier ones intact.</p>
<p>This (transfer learning) principle works fairly well and gets us about <code>92%</code> accuracy. To improve this further, we need to <strong><code>unfreeze</code></strong> all the layers in the models and adjust their weights during the training.</p>
<ul>
<li>
<code>learn.unfreeze()</code> will unfreeze the whole model - backbone and the additional layers</li>
<li>
<code>learn.fit_one_cycle(1)</code> thereafter will try to teach / change weights on the whole model. Often this results in lower accuracy because the initial layers of the model need not be changed as much since they often do preliminary work compared to the later layers which do the actual classification.</li>
</ul>
<p>To resolve the lower accuracy issue, we need to introduce <strong>learning rate</strong> and modify the weights of the initial layers much less frequently than those of the later layers. Learning rate is usually specified as a list of floats to match each layer in the model. In Fastai, we use the <code>slice(low, high)</code> Python function to evenly distribute <span class="caps">LR</span> between the first and last layers of the model.</p>
<ul>
<li>Run <code>learn.lr_find()</code> where the <span class="caps">API</span> will evaluate various learning rates and find the loss for each.</li>
<li>Run <code>learn.recorder.plot(suggestion=True, show_grid=True)</code> to view the learning rate plot. It looks like below:</li>
</ul>
<p><img alt="" src="../../../../images/fastai-lr1.jpg"></p>
<p>In general, we are not looking for learning at lowest loss, but for rate at the steepest segment of the loss curve. Using this suggestion, you can run</p>
<div class="code"><pre class="code literal-block"><span class="o">%%</span><span class="n">time</span>
<span class="n">learn</span><span class="o">.</span><span class="n">unfreeze</span><span class="p">()</span>
<span class="n">learn</span><span class="o">.</span><span class="n">fit_one_cycle</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">max_lr</span><span class="o">=</span><span class="nb">slice</span><span class="p">(</span><span class="mf">1e-6</span><span class="p">,</span><span class="mf">1e-5</span><span class="p">))</span>  <span class="c1"># LR chosen from the suggestion in the image</span>

<span class="o">&gt;&gt;&gt;</span>
<span class="n">epoch</span>   <span class="n">train_loss</span>  <span class="n">valid_loss</span>  <span class="n">error_rate</span>  <span class="n">time</span>
    <span class="mi">0</span>   <span class="mf">0.230512</span>    <span class="mf">0.231129</span>    <span class="mf">0.067659</span>    <span class="mi">02</span><span class="p">:</span><span class="mi">13</span>
    <span class="mi">1</span>   <span class="mf">0.246171</span>    <span class="mf">0.228836</span>    <span class="mf">0.064276</span>    <span class="mi">02</span><span class="p">:</span><span class="mi">15</span>

<span class="n">Wall</span> <span class="n">time</span><span class="p">:</span> <span class="mi">4</span><span class="nb">min</span> <span class="mi">28</span><span class="n">s</span>
</pre></div>

<p>With an additional 4.5 minutes, we improved the accuracy to <code>93%</code>. You can then save that model as <code>learn.save('pets-lesson01-stage-2', return_path=True)</code> for later.</p>
<h4 id="predict-on-real-world-data">Predict on real world data<a href="#predict-on-real-world-data" class="headerlink" title="Permalink to this heading">¶</a></h4>
<p>To predict on any given image, use the <code>fastai.vision.image.open_image()</code> function to load an image. You get back an <code>fastai.vision.image.Image</code> object that can be passed to <code>learn.predict()</code> function.</p>
<p>The prediction is a <code>tuple</code> of (<code>Category</code>, <code>category index</code>, <code>probabilities for each class</code>).</p>
<h3 id="hyper-parameter-tuning">Hyper-parameter tuning<a href="#hyper-parameter-tuning" class="headerlink" title="Permalink to this heading">¶</a></h3>
<h4 id="learning-rate-too-high">Learning rate too high<a href="#learning-rate-too-high" class="headerlink" title="Permalink to this heading">¶</a></h4>
<p>When the rate it too high, the validation loss gets obscenely high - like an impossible number. The default <code>max_lr</code> is <code>0.003</code>.</p>
<h4 id="learning-rate-too-low">Learning rate too low<a href="#learning-rate-too-low" class="headerlink" title="Permalink to this heading">¶</a></h4>
<p>When the rate is too small, the model’s validation drops, but very very slowly. The command <code>learn.recorder.plot_losses()</code> will plot the validation and training loss for visual interpretation. You can bump the rate by a factor of <code>10</code> or <code>100</code> and try again.</p>
<h4 id="training-loss-validation-loss">Training loss &gt; Validation loss<a href="#training-loss-validation-loss" class="headerlink" title="Permalink to this heading">¶</a></h4>
<p>When a model is properly trained, the training loss is typically lower than validation loss. If the training loss is greater, it means the model is not trained enough - try increasing number of epochs or increase the learning rate.</p>
<h4 id="too-few-epochs">Too few epochs<a href="#too-few-epochs" class="headerlink" title="Permalink to this heading">¶</a></h4>
<p>Too few epochs and too low <span class="caps">LR</span> look alike. For instance when you train for just 1 epoch, the training loss might be greater than validation loss. Or, the difference between training and validation might be too high. Try increasing epochs or the <span class="caps">LR</span>.</p>
<h4 id="too-many-epochs">Too many epochs<a href="#too-many-epochs" class="headerlink" title="Permalink to this heading">¶</a></h4>
<p>Too many epochs is too much training and can lead to <strong><code>overfitting</code></strong>. However, it is quite difficult to overfit in deep learning in practice. A sign of overfitting is when the model error starts increasing after a few epochs.</p>
    </div>
    

</article>
</div>
        <!--End of body content-->

        <footer id="footer">
            Contents © 2023         <a href="mailto:atma.mani@outlook.com">Atma Mani</a> - Powered by         <a href="https://getnikola.com" rel="nofollow">Nikola</a>         
            
        </footer>
</div>
</div>


            <script src="../../../../assets/js/all-nocdn.js"></script><!-- fancy dates --><script>
    moment.locale("en");
    fancydates(0, "YYYY-MM-DD HH:mm");
    </script><!-- end fancy dates --><script>
    baguetteBox.run('div#content', {
        ignoreClass: 'islink',
        captions: function(element) {
            return element.getElementsByTagName('img')[0].alt;
    }});
    </script>
</body>
</html>