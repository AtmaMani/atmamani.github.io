<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Building data science projects using Azure-ML stack | Atma's blog</title>
<link href="../../assets/css/all-nocdn.css" rel="stylesheet" type="text/css">
<link href="../../assets/css/ipython.min.css" rel="stylesheet" type="text/css">
<link href="../../assets/css/nikola_ipython.css" rel="stylesheet" type="text/css">
<meta name="theme-color" content="#d4567b">
<meta name="generator" content="Nikola (getnikola.com)">
<link rel="alternate" type="application/rss+xml" title="RSS" hreflang="en" href="../../rss.xml">
<link rel="canonical" href="https://atmamani.github.io/blog/building-data-science-projects-using-azure-ml-stack/">
<link rel="icon" href="../../scatter-16.png" sizes="16x16">
<link rel="icon" href="../../scatter-32.png" sizes="32x32">
<link rel="icon" href="../../scatter-64.png" sizes="64x64">
<link rel="icon" href="../../scatter-128.png" sizes="128x128">
<!--[if lt IE 9]><script src="../../assets/js/html5.js"></script><![endif]--><!-- Global site tag (gtag.js) - Google Analytics --><script async src="https://www.googletagmanager.com/gtag/js?id=UA-113202945-1"></script><script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-113202945-1');
</script><meta name="author" content="Atma Mani">
<link rel="prev" href="../tutorials-for-arcgis/" title="A few tutorials I authored for ArcGIS" type="text/html">
<link rel="next" href="../imagery-in-arcgis-ecosystem/" title="Imagery in ArcGIS ecosystem" type="text/html">
<meta property="og:site_name" content="Atma's blog">
<meta property="og:title" content="Building data science projects using Azure-ML stack">
<meta property="og:url" content="https://atmamani.github.io/blog/building-data-science-projects-using-azure-ml-stack/">
<meta property="og:description" content="This wiki covers the steps involved in building a data science project using Azure Machine Learning Workbench product. This also covers the steps involved in productionizing the model as a web service">
<meta property="og:type" content="article">
<meta property="article:published_time" content="2018-02-26T10:25:00-08:00">
<meta property="article:tag" content="arcgis">
<meta property="article:tag" content="azure">
<meta property="article:tag" content="data-science">
<meta property="article:tag" content="python">
<meta property="article:tag" content="python api">
</head>
<body>
<a href="#content" class="sr-only sr-only-focusable">Skip to main content</a>

<!-- Menubar -->

<nav class="navbar navbar-inverse navbar-static-top"><div class="container">
<!-- This keeps the margins nice -->
        <div class="navbar-header">
            <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-navbar" aria-controls="bs-navbar" aria-expanded="false">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="https://atmamani.github.io/">

                <span id="blog-title">Atma's blog</span>
            </a>
        </div>
<!-- /.navbar-header -->
        <div class="collapse navbar-collapse" id="bs-navbar" aria-expanded="false">
            <ul class="nav navbar-nav">
<li class="dropdown">
<a href="#" class="dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">Projects <b class="caret"></b></a>
            <ul class="dropdown-menu">
<li>
<a href="../../projects/math/">Learn math with Python</a>
                    </li>
<li>
<a href="../../projects/stats/">Learn stats with Python</a>
                    </li>
<li>
<a href="../../projects/ml/">Machine Learning projects</a>
                    </li>
<li>
<a href="../../projects/dl/">Deep Learning projects</a>
                    </li>
<li>
<a href="../../projects/spatial/">Spatial analysis</a>
                    </li>
<li>
<a href="../../projects/thermal/">Thermal remote sensing</a>
                    </li>
<li>
<a href="../../projects/mwrs/">Microwave remote sensing</a>
                    </li>
<li>
<a href="../../projects/fun/">Fun projects</a>
            </li>
</ul>
</li>
<li>
<a href="../">Blog</a>
                </li>
<li>
<a href="../../talks/">Talks</a>
            </li>
<li class="dropdown">
<a href="#" class="dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">Cheatsheets <b class="caret"></b></a>
            <ul class="dropdown-menu">
<li>
<a href="../../cheatsheets/learning-resources/">General learning resources</a>
                    </li>
<li>
<a href="../../"><hr></a>
                    </li>
<li>
<a href="../../cheatsheets/python/python_cheat_sheet_1/">Python basics, comprehensions</a>
                    </li>
<li>
<a href="../../cheatsheets/python/python_cheat_sheet_2/">Python OO and exception handling</a>
                    </li>
<li>
<a href="../../cheatsheets/python/python_cheat_sheet_3/">Python map, reduce, lambdas</a>
                    </li>
<li>
<a href="../../images/regex-mindmap.jpg">Python regex</a>
                    </li>
<li>
<a href="../../"><hr></a>
                    </li>
<li>
<a href="../../cheatsheets/conda_cheat_sheet/">Conda basics</a>
                    </li>
<li>
<a href="../../"><hr></a>
                    </li>
<li>
<a href="../../cheatsheets/numpy/numpy_cheat_sheet_1/">NumPy basics</a>
                    </li>
<li>
<a href="../../cheatsheets/numpy/numpy_cheat_sheet_2/">NumPy array slicing, dicing, searching</a>
                    </li>
<li>
<a href="../../"><hr></a>
                    </li>
<li>
<a href="../../cheatsheets/pandas/pandas_cheat_sheet_1/">Pandas basics</a>
                    </li>
<li>
<a href="../../cheatsheets/pandas/pandas_cheat_sheet_2/">Pandas multilevel index, <br>    missing data, aggregation, merging</a>
                    </li>
<li>
<a href="../../cheatsheets/pandas/pandas_cheat_sheet_3/">Productivity with Pandas</a>
                    </li>
<li>
<a href="../../cheatsheets/pandas/pandas_data_viz_1/">Pandas data visualization</a>
                    </li>
<li>
<a href="../../"><hr></a>
                    </li>
<li>
<a href="../../cheatsheets/matplotlib/matplotlib_1/">Matplotlib basics</a>
                    </li>
<li>
<a href="../../cheatsheets/matplotlib/matplotlib_2/">Matplotlib log scales, ticks, scientific</a>
                    </li>
<li>
<a href="../../"><hr></a>
                    </li>
<li>
<a href="../../cheatsheets/seaborn/seaborn_cheat_sheet_1/">Seaborn dist, joint, pair, rug plots</a>
                    </li>
<li>
<a href="../../cheatsheets/seaborn/seaborn_cheat_sheet_2/">Seaborn categorical - bar, count, <br>violin, strip, swarm plots</a>
                    </li>
<li>
<a href="../../cheatsheets/seaborn/seaborn_cheat_sheet_3/">Seaborn matrix, regression - heatmap, <br> cluster, regression</a>
                    </li>
<li>
<a href="../../cheatsheets/seaborn/seaborn_cheat_sheet_4/">Seaborn grids &amp; custom - pair, facet grids <br> customization</a>
                    </li>
<li>
<a href="../../"><hr></a>
                    </li>
<li>
<a href="../../cheatsheets/plotly/plotly_cufflinks_cheat_sheet_1/">Plotly introduction</a>
                    </li>
<li>
<a href="../../cheatsheets/plotly/plotly_cufflinks_cheat_sheet_2/">Plotly - interactive plotting</a>
                    </li>
<li>
<a href="../../cheatsheets/plotly/plotly_geographical_plotting_1/">Plotly - geographic plotting</a>
                    </li>
<li>
<a href="../../"><hr></a>
                    </li>
<li>
<a href="../../cheatsheets/r_cheat_sheet_1/">R basics</a>
                    </li>
<li>
<a href="../../cheatsheets/octave-1/">Octave / MATLAB - basics</a>
                    </li>
<li>
<a href="../../cheatsheets/octave-2/">Octave - handling data</a>
                    </li>
<li>
<a href="../../cheatsheets/js_essentials/">Javascript essentials</a>
                    </li>
<li>
<a href="../../cheatsheets/latex-1/">Latex introduction</a>
                    </li>
<li>
<a href="../../cheatsheets/docker-1/">Docker introduction</a>
                    </li>
<li>
<a href="../../"><hr></a>
                    </li>
<li>
<a href="../../cheatsheets/open-geo/geopandas-1/">GeoPandas - IO, projections, plotting</a>
                    </li>
<li>
<a href="../../cheatsheets/open-geo/geopandas-2/">GeoPandas - GP, IO, interactive plotting, geocoding</a>
                    </li>
<li>
<a href="../../cheatsheets/open-geo/geopandas-3/">GeoPandas - spatial overlays, topology</a>
                    </li>
<li>
<a href="../../cheatsheets/open-geo/geopandas-4/">GeoPandas - PySal, OSM data IO</a>
                    </li>
<li>
<a href="../../cheatsheets/open-geo/open-geo-raster-1/">Rasterio - IO, plotting, histograms</a>
                    </li>
<li>
<a href="../../cheatsheets/open-geo/open-geo-raster-2/">Rasterio - hyperspectral, SAM</a>
                    </li>
<li>
<a href="../../cheatsheets/open-geo/postgis-1/">PostGIS - introduction</a>
                    </li>
<li>
<a href="../../cheatsheets/open-geo/postgis-2/">PostGIS - SQLAlchemy, GeoAlchemy, GeoPandas</a>
                    </li>
<li>
<a href="../../"><hr></a>
                    </li>
<li>
<a href="../../cheatsheets/web-development/">Web Development</a>
                    </li>
<li>
<a href="../../cheatsheets/html/">HTML basics</a>
            </li>
</ul>
</li>
<li>
<a href="../../apps/">Apps</a>
                </li>
<li>
<a href="../../rss.xml">RSS feed</a>

                
            </li>
</ul>
<!-- DuckDuckGo custom search --><form method="get" id="search" action="https://duckduckgo.com/" class="navbar-form pull-left">
<input type="hidden" name="sites" value="https://atmamani.github.io/"><input type="hidden" name="k8" value="#444444"><input type="hidden" name="k9" value="#D51920"><input type="hidden" name="kt" value="h"><input type="text" name="q" maxlength="255" placeholder="Search…" class="span2" style="margin-top: 4px;"><input type="submit" value="DuckDuckGo Search" style="visibility: hidden;">
</form>
<!-- End of custom search -->


            <ul class="nav navbar-nav navbar-right"></ul>
</div>
<!-- /.navbar-collapse -->
    </div>
<!-- /.container -->
</nav><!-- End of Menubar --><div class="container" id="content" role="main">
    <div class="body-content">
        <!--Body content-->
        <div class="row">
            
            
<article class="post-text h-entry hentry postpage" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title" itemprop="headline name"><a href="." class="u-url">Building data science projects using Azure-ML stack</a></h1>

        <div class="metadata">
            <p class="byline author vcard"><span class="byline-name fn" itemprop="author">
                    Atma Mani
            </span></p>
            <p class="dateline">
            <a href="." rel="bookmark">
            <time class="published dt-published" datetime="2018-02-26T10:25:00-08:00" itemprop="datePublished" title="2018-02-26 10:25">2018-02-26 10:25</time></a>
            </p>
            

        </div>
        

    </header><div class="e-content entry-content" itemprop="articleBody text">
    <div>
<p>This wiki covers the steps involved in building a data science project using Azure Machine Learning Workbench product. This also covers the steps involved in productionizing the model as a web service and accessing it over HTTP using its REST API.
<!-- TEASER_END --></p>
<p><strong>ToC</strong>
<!-- MarkdownTOC --></p>
<ul>
<li>
<a href="#Azure-ML-Workbench">Azure ML Workbench</a><ul>
<li><a href="#Runtime-environments">Runtime environments</a></li>
<li><a href="#Deployment-environments">Deployment environments</a></li>
</ul>
</li>
<li><a href="#Azure-ML-portal">Azure ML portal</a></li>
<li>
<a href="#Walk-through">Walk through</a><ul>
<li><a href="#Initialization">Initialization</a></li>
<li><a href="#Model-development">Model development</a></li>
<li>
<a href="#Operationalization">Operationalization</a><ul>
<li><a href="#Notes">Notes</a></li>
</ul>
</li>
</ul>
</li>
</ul>
<!-- /MarkdownTOC --><p>Azure ML consists of two major parts
 - Azure ML portal
 - Azure ML Workbench</p>
<h3>Azure ML Workbench</h3>
<p>Azure ML provides a cloud infrastructure to turn your machine learning projects into production code with the scalability and availability of its cloud infrastructure. As of this blog, Azure itself does not have ML as Service, but it allows you to turn your projects into one.</p>
<p>The Workbench is a <strong>desktop application + Python libraries</strong> with which you build your ML experiments, taking it from data cleaning, model building to refinement. It provides frameworks to </p>
<ul>
<li>access datasets</li>
<li>build models with defined inputs and outputs</li>
<li>refine models by tuning hyperparameters and export model parameters and learning artifacts</li>
</ul>
<p>The Workbench has a <strong>run history</strong> that allows you to visualize the run results as a time-series and helps you visualize the effects of each run.</p>
<h4>Runtime environments</h4>
<p>The Workbench supports at-least 3 different runtimes.</p>
<ul>
<li>
<code>local</code> - This is your local anaconda Python environment (or R env)</li>
<li>
<code>docker-python</code> - This encapsulates the <code>local</code> environment as a Docker container and runs it with this container. This container could run locally, on host OS, or can run on a remote machine as well (such as a VM or HDInsights cluster).</li>
<li>
<code>docker-pyspark</code> - similar, but is useful for distributed computation using Spark.</li>
</ul>
<h4>Deployment environments</h4>
<p>The output from Workbench is your Docker image. Azure ML helps you to deploy this image on <strong>Azure Container Services</strong> and get a <code>REST</code> API for predictions and inference during production.</p>
<p>The ML model consists of 
 - model file (or dir of such files)
 - Python file implementing model scoring function
 - Conda dependency file (.yml)
 - runtime environment file
 - schema file for REST API parameters
 - manifest file (auto generated) for building Docker image</p>
<p><img alt="schematic" src="https://docs.microsoft.com/en-us/azure/machine-learning/preview/media/model-management-overview/modelmanagement.png"></p>
<p>Azure ML Model Management console allows your register and track your models like a version control system.</p>
<h3>Azure ML portal</h3>
<p><a href="https://portal.azure.com/">Azure dashboard</a> contains all Azure sub products, including the ML services. Sign in with free Outlook account or Office 365 account and you get <code>$200</code> in free credits.</p>
<p>In the console, search for <a href="https://portal.azure.com/#blade/HubsExtension/Resources/resourceType/Microsoft.MachineLearningExperimentation">Machine learning experimentation</a> (which is in preview at the time of this article). This service / dashboard provides an environment for the rest of this article.</p>
<h3>Walk through</h3>
<p>An important process is to write the Python code (in scripts and notebooks) by using <strong><code>azureml</code> Python library</strong> for data access, logging and printing. This is the hook for the Workbench UX to interpret model refinement and display them in the dashboard.</p>
<h4>Initialization</h4>
<ol>
<li>Log into the ML portal, create a new experiment. <a href="https://docs.microsoft.com/en-us/azure/machine-learning/preview/media/quickstart-installation/portal-create-experimentation.png">Help image</a>
</li>
<li>Install Workbench. Note: You need macOS, Win 10 or higher for Docker to run. Then sign into the workbench using the same account. Your experimentation account shows up on Workbench. <a href="https://docs.microsoft.com/en-us/azure/machine-learning/preview/media/quickstart-installation/run_view.png">Help image</a>
</li>
<li>Create a new project, pick from a template if necessary. <a href="https://docs.microsoft.com/en-us/azure/machine-learning/preview/media/tutorial-classifying-iris/new_project.png">Help image</a>
</li>
</ol>
<h4>Model development</h4>
<p>Your Azure ML projects are primarily <code>git</code> repositories. When you open an existing template project, the <code>home</code> tab renders the <code>readme.md</code> file.</p>
<ol>
<li>
<strong>Add datasets</strong> - Click on the data tab and plus sign. Use wizard to add data sources. If data is tabular, the Workbench attempts to display it as a table and provide some preliminary statistics.</li>
</ol>
<p>ML Workbench wants to keep a record of all your EDA and data wrangling steps, to aid reproducibility. Hence it stores a <code>.dsource</code> to record how data is input and a <code>.dprep</code> to record the transformations performed on the data.</p>
<ol>
<li>
<p>A <code>.dsource</code> file gets created that contains connections to your dataset and how your file is read.</p>
</li>
<li>
<p>Any data preparation performed by using the built-in <strong>prepare</strong> tool is stored in <code>.dprep</code> file.</p>
</li>
</ol>
<p>At any time, you can do the same actions in Python, or turn the UX actions into Python code by right clicking the <code>.dprep</code> or <code>.dsource</code> file and generating code file. The sample code that reads from <code>.dsource</code> and returns a pandas DataFrame is below. Script proceeds to run data preparation using <code>.dprep</code> file.</p>
<pre class="code literal-block"><span></span><span class="kn">from</span> <span class="nn">azureml.dataprep</span> <span class="kn">import</span> <span class="n">datasource</span>
<span class="kn">from</span> <span class="nn">azureml.dataprep</span> <span class="kn">import</span> <span class="n">package</span>

<span class="n">df</span> <span class="o">=</span> <span class="n">datasource</span><span class="o">.</span><span class="n">load_datasource</span><span class="p">(</span><span class="s1">'iris.dsource'</span><span class="p">)</span>
<span class="c1"># df.head(10)</span>

<span class="c1"># column-prep.dprep is my data prep file name.</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">package</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="s1">'column-prep.dprep'</span><span class="p">,</span> <span class="n">dataflow_idx</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
</pre>


<ol>
<li>Serialize your model and its weights using <code>pickle</code> library</li>
</ol>
<pre class="code literal-block"><span></span><span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">'./outputs/model.pkl'</span><span class="p">,</span> <span class="s1">'wb'</span><span class="p">)</span> <span class="k">as</span> <span class="n">mh</span><span class="p">:</span>
    <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">classifier</span><span class="p">,</span> <span class="n">mh</span><span class="p">)</span>
</pre>


<ol>
<li>
<p>Save your plots as <code>.png</code> files into the <code>./outputs</code> folder. The Workbench picks this up automatically. For each run, the Workbench stores the outputs within the run numbered folder. From the run dashboard, you can download a file later for any run.</p>
</li>
<li>
<p>Choose runtime as <code>docker-python</code>. The Docker base image is specified in the <code>aml_config/docker.compute</code> and run configurations, Python dependencies in <code>docker-python.runconfig</code> files. Workbench first builds a Docker image from base image, installs dependencies and then runs the file.</p>
</li>
</ol>
<h4>Operationalization</h4>
<p>Once model is developed, you need to create a <strong>schema</strong> file that contains the inputs and output of the prediction service. This service is a Python file that reads the <strong>pickled</strong> model file, accepts inputs, performs predictions and returns the results.</p>
<p>The <code>azureml</code> Python library has methods such as <code>azureml.api.realtime.services.generate_schema()</code> to generate schema. To specify the data types, use <code>azureml.api.schema.dataTypes.DataTypes</code> and <code>azureml.api.schema.sampleDefinition.SampleDefinition</code> to specify a sample input. Documentation on these is very thin and is left to user experimentation.</p>
<h5>Notes</h5>
<ul>
<li>It appears that using Workbench UX to read and clean data into DataFrames is optional. You can as well do all in Python in standard way and create a DF from a .csv file.</li>
<li>You accept script parameters as <strong>command line arguments</strong>. The Workbench UX provides a generic args text box into which you can type the values when running from UX.</li>
<li>The text you want persisted in the logs should be sent to Azure ML logger</li>
</ul>
<pre class="code literal-block"><span></span><span class="kn">from</span> <span class="nn">azureml.logging</span> <span class="kn">import</span> <span class="n">get_azureml_logger</span>
<span class="n">run_logger</span> <span class="o">=</span> <span class="n">get_azureml_logger</span><span class="p">()</span>

<span class="n">run_logger</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s1">'text'</span><span class="p">)</span>
</pre>


<ul>
<li>
<p>Write your scripts such that there is <code>1</code> main Python file which in turn calls other files that are necessary.</p>
</li>
<li>
<p><code>control_log</code> file contains the running log of the job with details injected by Workbench</p>
</li>
<li>
<code>driver_log</code> file contains the print statements</li>
</ul>
<hr>
<p><strong>Sources</strong>
 - <a href="https://docs.microsoft.com/en-us/azure/machine-learning/preview">Azure ML help</a></p>
</div>
    </div>
    <aside class="postpromonav"><nav><ul itemprop="keywords" class="tags">
<li><a class="tag p-category" href="../../categories/arcgis/" rel="tag">arcgis</a></li>
            <li><a class="tag p-category" href="../../categories/azure/" rel="tag">azure</a></li>
            <li><a class="tag p-category" href="../../categories/data-science/" rel="tag">data-science</a></li>
            <li><a class="tag p-category" href="../../categories/python/" rel="tag">python</a></li>
            <li><a class="tag p-category" href="../../categories/python-api/" rel="tag">python api</a></li>
        </ul>
<ul class="pager hidden-print">
<li class="previous">
                <a href="../tutorials-for-arcgis/" rel="prev" title="A few tutorials I authored for ArcGIS">Previous post</a>
            </li>
            <li class="next">
                <a href="../imagery-in-arcgis-ecosystem/" rel="next" title="Imagery in ArcGIS ecosystem">Next post</a>
            </li>
        </ul></nav></aside></article>
</div>
        <!--End of body content-->

        <footer id="footer">
            Contents © 2020         <a href="mailto:atma.mani@outlook.com">Atma Mani</a> - Powered by         <a href="https://getnikola.com" rel="nofollow">Nikola</a>         
            
        </footer>
</div>
</div>


            <script src="../../assets/js/all-nocdn.js"></script><!-- fancy dates --><script>
    moment.locale("en");
    fancydates(0, "YYYY-MM-DD HH:mm");
    </script><!-- end fancy dates --><script>
    baguetteBox.run('div#content', {
        ignoreClass: 'islink',
        captions: function(element) {
            return element.getElementsByTagName('img')[0].alt;
    }});
    </script>
</body>
</html>
