<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>How many snakes do you need? - Challenges in parallel computing | Atma's blog</title>
<link href="../../assets/css/all-nocdn.css" rel="stylesheet" type="text/css">
<link href="../../assets/css/ipython.min.css" rel="stylesheet" type="text/css">
<link href="../../assets/css/nikola_ipython.css" rel="stylesheet" type="text/css">
<meta name="theme-color" content="#d4567b">
<meta name="generator" content="Nikola (getnikola.com)">
<link rel="alternate" type="application/rss+xml" title="RSS" hreflang="en" href="../../rss.xml">
<link rel="canonical" href="https://atmamani.github.io/blog/how-many-snakes-python-concurrency-3/">
<link rel="icon" href="../../scatter-16.png" sizes="16x16">
<link rel="icon" href="../../scatter-32.png" sizes="32x32">
<link rel="icon" href="../../scatter-64.png" sizes="64x64">
<link rel="icon" href="../../scatter-128.png" sizes="128x128">
<!--[if lt IE 9]><script src="../../assets/js/html5.js"></script><![endif]--><!-- Global site tag (gtag.js) - Google Analytics --><script async src="https://www.googletagmanager.com/gtag/js?id=UA-113202945-1"></script><script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-113202945-1');
</script><meta name="author" content="Atma Mani">
<meta name="robots" content="noindex">
<meta property="og:site_name" content="Atma's blog">
<meta property="og:title" content="How many snakes do you need? - Challenges in parallel computing">
<meta property="og:url" content="https://atmamani.github.io/blog/how-many-snakes-python-concurrency-3/">
<meta property="og:description" content="Concurrency and parallelism as seen earlier can speed up your Python application. However, when not careful, they can crop up a bunch of specific bugs and challenges. We will cover some of those in th">
<meta property="og:type" content="article">
<meta property="article:published_time" content="2021-03-30T00:00:00-07:00">
<meta property="article:tag" content="parallel processing">
<meta property="article:tag" content="processes">
<meta property="article:tag" content="python">
<meta property="article:tag" content="threads">
</head>
<body>
<a href="#content" class="sr-only sr-only-focusable">Skip to main content</a>

<!-- Menubar -->

<nav class="navbar navbar-inverse navbar-static-top"><div class="container">
<!-- This keeps the margins nice -->
        <div class="navbar-header">
            <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-navbar" aria-controls="bs-navbar" aria-expanded="false">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="https://atmamani.github.io/">

                <span id="blog-title">Atma’s blog</span>
            </a>
        </div>
<!-- /.navbar-header -->
        <div class="collapse navbar-collapse" id="bs-navbar" aria-expanded="false">
            <ul class="nav navbar-nav">
<li class="dropdown">
<a href="#" class="dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">Projects <b class="caret"></b></a>
            <ul class="dropdown-menu">
<li>
<a href="../../projects/math/">Learn math with Python</a>
                    </li>
<li>
<a href="../../projects/stats/">Learn stats with Python</a>
                    </li>
<li>
<a href="../../projects/ml/">Machine Learning projects</a>
                    </li>
<li>
<a href="../../projects/dl/">Deep Learning projects</a>
                    </li>
<li>
<a href="../../projects/spatial/">Spatial analysis</a>
                    </li>
<li>
<a href="../../projects/thermal/">Thermal remote sensing</a>
                    </li>
<li>
<a href="../../projects/mwrs/">Microwave remote sensing</a>
                    </li>
<li>
<a href="../../projects/cloud/">Cloud computing</a>
                    </li>
<li>
<a href="../../projects/fun/">Fun projects</a>
            </li>
</ul>
</li>
<li>
<a href="../">Blog</a>
                </li>
<li>
<a href="../../talks/">Talks</a>
                </li>
<li>
<a href="../../books/">Books</a>
            </li>
<li class="dropdown">
<a href="#" class="dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">Cheatsheets <b class="caret"></b></a>
            <ul class="dropdown-menu">
<li>
<a href="../../cheatsheets/learning-resources/">General learning resources</a>
                    </li>
<li>
<a href="../../"><hr></a>
                    </li>
<li>
<a href="../../cheatsheets/python/python_datatypes/">Python datatypes</a>
                    </li>
<li>
<a href="../../cheatsheets/python/python_numeric_datatypes/">Python numeric datatypes</a>
                    </li>
<li>
<a href="../../cheatsheets/python/python_conditional_execution/">Python conditional execution</a>
                    </li>
<li>
<a href="../../cheatsheets/python/python_functions/">Python functions</a>
                    </li>
<li>
<a href="../../cheatsheets/python/python_iterations/">Python iterations</a>
                    </li>
<li>
<a href="../../cheatsheets/python/python_exception_handling/">Python exception handling</a>
                    </li>
<li>
<a href="../../cheatsheets/python/python_classes/">Python classes</a>
                    </li>
<li>
<a href="../../cheatsheets/python/python_memory/">Python memory, ref counts, garbage collection</a>
                    </li>
<li>
<a href="../../cheatsheets/python/python_mutability/">Python - mutability and immutability</a>
                    </li>
<li>
<a href="../../cheatsheets/python/python_language_optimizations/">Python - language optimizations</a>
                    </li>
<li>
<a href="../../images/regex-mindmap.jpg">Python regex</a>
                    </li>
<li>
<a href="../../"><hr></a>
                    </li>
<li>
<a href="../../cheatsheets/golang/">Go introduction</a>
                    </li>
<li>
<a href="../../cheatsheets/golang/golang-basics/">Go basics</a>
                    </li>
<li>
<a href="../../cheatsheets/golang/golang-datatypes/">Go data types</a>
                    </li>
<li>
<a href="../../cheatsheets/golang/golang-control-flow/">Go control flow</a>
                    </li>
<li>
<a href="../../cheatsheets/golang/goroutine/">Goroutines - concurrency in Go lang</a>
                    </li>
<li>
<a href="../../"><hr></a>
                    </li>
<li>
<a href="../../cheatsheets/conda_cheat_sheet/">Conda basics</a>
                    </li>
<li>
<a href="../../cheatsheets/mamba_cheat_sheet/">Mamba basics</a>
                    </li>
<li>
<a href="../../"><hr></a>
                    </li>
<li>
<a href="../../cheatsheets/numpy/numpy_cheat_sheet_1/">NumPy basics</a>
                    </li>
<li>
<a href="../../cheatsheets/numpy/numpy_cheat_sheet_2/">NumPy array slicing, dicing, searching</a>
                    </li>
<li>
<a href="../../"><hr></a>
                    </li>
<li>
<a href="../../cheatsheets/pandas/pandas_cheat_sheet_1/">Pandas basics</a>
                    </li>
<li>
<a href="../../cheatsheets/pandas/pandas_cheat_sheet_2/">Pandas multilevel index, <br>    missing data, aggregation, merging</a>
                    </li>
<li>
<a href="../../cheatsheets/pandas/pandas_cheat_sheet_3/">Productivity with Pandas</a>
                    </li>
<li>
<a href="../../cheatsheets/pandas/pandas_data_viz_1/">Pandas data visualization</a>
                    </li>
<li>
<a href="../../"><hr></a>
                    </li>
<li>
<a href="../../cheatsheets/matplotlib/matplotlib_1/">Matplotlib basics</a>
                    </li>
<li>
<a href="../../cheatsheets/matplotlib/matplotlib_2/">Matplotlib log scales, ticks, scientific</a>
                    </li>
<li>
<a href="../../cheatsheets/matplotlib/matplotlib_geo/">Geographical plotting with Basemap - matplotlib toolkit</a>
                    </li>
<li>
<a href="../../"><hr></a>
                    </li>
<li>
<a href="../../cheatsheets/seaborn/seaborn_cheat_sheet_1/">Seaborn dist, joint, pair, rug plots</a>
                    </li>
<li>
<a href="../../cheatsheets/seaborn/seaborn_cheat_sheet_2/">Seaborn categorical - bar, count, <br>violin, strip, swarm plots</a>
                    </li>
<li>
<a href="../../cheatsheets/seaborn/seaborn_cheat_sheet_3/">Seaborn matrix, regression - heatmap, <br> cluster, regression</a>
                    </li>
<li>
<a href="../../cheatsheets/seaborn/seaborn_cheat_sheet_4/">Seaborn grids <span class="amp">&amp;</span> custom - pair, facet grids <br> customization</a>
                    </li>
<li>
<a href="../../"><hr></a>
                    </li>
<li>
<a href="../../cheatsheets/plotly/plotly_cufflinks_cheat_sheet_1/">Plotly introduction</a>
                    </li>
<li>
<a href="../../cheatsheets/plotly/plotly_cufflinks_cheat_sheet_2/">Plotly - interactive plotting</a>
                    </li>
<li>
<a href="../../cheatsheets/plotly/plotly_geographical_plotting_1/">Plotly - geographic plotting</a>
                    </li>
<li>
<a href="../../"><hr></a>
                    </li>
<li>
<a href="../../cheatsheets/r_cheat_sheet_1/">R basics</a>
                    </li>
<li>
<a href="../../cheatsheets/octave-1/">Octave / <span class="caps">MATLAB</span> - basics</a>
                    </li>
<li>
<a href="../../cheatsheets/octave-2/">Octave - handling data</a>
                    </li>
<li>
<a href="../../cheatsheets/js_essentials/">Javascript essentials</a>
                    </li>
<li>
<a href="../../cheatsheets/latex-1/">Latex introduction</a>
                    </li>
<li>
<a href="../../cheatsheets/docker-1/">Docker introduction</a>
                    </li>
<li>
<a href="../../cheatsheets/grep-1/">Grep introduction</a>
                    </li>
<li>
<a href="../../"><hr></a>
                    </li>
<li>
<a href="../../cheatsheets/sql/sql-1"><span class="caps">SQL</span> introduction</a>
                    </li>
<li>
<a href="../../cheatsheets/sql/sql-2"><span class="caps">SQL</span> Queries</a>
                    </li>
<li>
<a href="../../"><hr></a>
                    </li>
<li>
<a href="../../cheatsheets/open-geo/geopandas-1/">GeoPandas - <span class="caps">IO</span>, projections, plotting</a>
                    </li>
<li>
<a href="../../cheatsheets/open-geo/geopandas-2/">GeoPandas - <span class="caps">GP</span>, <span class="caps">IO</span>, interactive plotting, geocoding</a>
                    </li>
<li>
<a href="../../cheatsheets/open-geo/geopandas-3/">GeoPandas - spatial overlays, topology</a>
                    </li>
<li>
<a href="../../cheatsheets/open-geo/geopandas-4/">GeoPandas - PySal, <span class="caps">OSM</span> data <span class="caps">IO</span></a>
                    </li>
<li>
<a href="../../cheatsheets/open-geo/open-geo-raster-1/">Rasterio - <span class="caps">IO</span>, plotting, histograms</a>
                    </li>
<li>
<a href="../../cheatsheets/open-geo/open-geo-raster-2/">Rasterio - hyperspectral, <span class="caps">SAM</span></a>
                    </li>
<li>
<a href="../../cheatsheets/open-geo/reading-multidim-data-using-opengeotools/">Reading multi-dimensional data using open geo tools</a>
                    </li>
<li>
<a href="../../cheatsheets/open-geo/postgis-1/">PostGIS - introduction</a>
                    </li>
<li>
<a href="../../cheatsheets/open-geo/postgis-2/">PostGIS - SQLAlchemy, GeoAlchemy, GeoPandas</a>
                    </li>
<li>
<a href="../../cheatsheets/open-geo/gdal-1/"><span class="caps">GDAL</span> - an introduction</a>
                    </li>
<li>
<a href="../../cheatsheets/open-geo/gdal-2/"><span class="caps">GDAL</span> - quickstart</a>
                    </li>
<li>
<a href="../../cheatsheets/open-geo/gdal_t1/"><span class="caps">GDAL</span> training day 1</a>
                    </li>
<li>
<a href="../../cheatsheets/open-geo/gdal_t2/"><span class="caps">GDAL</span> training day 2</a>
                    </li>
<li>
<a href="../../cheatsheets/open-geo/gdal_t3/"><span class="caps">GDAL</span> training day 3</a>
                    </li>
<li>
<a href="../../"><hr></a>
                    </li>
<li>
<a href="../../cheatsheets/web-development/">Web Development</a>
                    </li>
<li>
<a href="../../cheatsheets/html/"><span class="caps">HTML</span> basics</a>
                    </li>
<li>
<a href="../../cheatsheets/yaml_syntax/"><span class="caps">YAML</span> Syntax basics</a>
            </li>
</ul>
</li>
<li>
<a href="../../apps/">Apps</a>
                </li>
<li>
<a href="../../rss.xml"><span class="caps">RSS</span> feed</a>

                
            </li>
</ul>
<!-- DuckDuckGo custom search --><form method="get" id="search" action="https://duckduckgo.com/" class="navbar-form pull-left">
<input type="hidden" name="sites" value="https://atmamani.github.io/"><input type="hidden" name="k8" value="#444444"><input type="hidden" name="k9" value="#D51920"><input type="hidden" name="kt" value="h"><input type="text" name="q" maxlength="255" placeholder="Search…" class="span2" style="margin-top: 4px;"><input type="submit" value="DuckDuckGo Search" style="visibility: hidden;">
</form>
<!-- End of custom search -->


            <ul class="nav navbar-nav navbar-right"></ul>
</div>
<!-- /.navbar-collapse -->
    </div>
<!-- /.container -->
</nav><!-- End of Menubar --><div class="container" id="content" role="main">
    <div class="body-content">
        <!--Body content-->
        <div class="row">
            
            
<article class="post-text h-entry hentry postpage" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title" itemprop="headline name"><a href="." class="u-url">How many snakes do you need? - Challenges in parallel computing</a></h1>

        <div class="metadata">
            <p class="byline author vcard p-author h-card"><span class="byline-name fn p-name" itemprop="author">
                    Atma Mani
            </span></p>
            <p class="dateline">
            <a href="." rel="bookmark">
            <time class="published dt-published" datetime="2021-03-30T00:00:00-07:00" itemprop="datePublished" title="2021-03-30 00:00">2021-03-30 00:00</time></a>
            </p>
            

        </div>
        

    </header><div class="e-content entry-content" itemprop="articleBody text">
    <p>Concurrency and parallelism as seen earlier can speed up your Python application. However, when not careful, they can crop up a bunch of specific bugs and challenges. We will cover some of those in this article.</p>
<h3 id="data-race">Data race<a href="#data-race" class="headerlink" title="Permalink to this heading">¶</a></h3>
<p>A common problem with concurrency is when multiple workers attempt to read the same location in memory and when at-least one of them is attempting to change the value.</p>
<div class="code"><pre class="code literal-block"><span class="kn">import</span> <span class="nn">threading</span>

<span class="n">garlic_count</span> <span class="o">=</span> <span class="mi">0</span>

<span class="k">def</span> <span class="nf">shopper</span><span class="p">():</span>
    <span class="k">global</span> <span class="n">garlic_count</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">'Current garlic count: '</span><span class="p">,</span> <span class="n">garlic_count</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10_000_000</span><span class="p">):</span>  <span class="c1"># 10 million</span>
        <span class="n">garlic_count</span> <span class="o">+=</span> <span class="mi">1</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">'__main__'</span><span class="p">:</span>
    <span class="n">barron</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">shopper</span><span class="p">)</span>
    <span class="n">olivia</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">shopper</span><span class="p">)</span>
    <span class="n">barron</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
    <span class="n">olivia</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
    <span class="n">barron</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>
    <span class="n">olivia</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">'We should buy'</span><span class="p">,</span> <span class="n">garlic_count</span><span class="p">,</span> <span class="s1">'garlic.'</span><span class="p">)</span>
</pre></div>

<p>The script above spawns <code>2</code> worker threads that increment the garlic count by <code>10</code> million. Ideally, they each are supposed to increment <code>10</code> million, resulting in a final count of <code>20</code> million. However, when you run it, you end up with this:</p>
<div class="code"><pre class="code literal-block">Current garlic count:  0
Current garlic count:  83186
We should buy 13724492 garlic.
</pre></div>

<p>which is a classic case of a data race.</p>
<h3 id="mutex-mutual-exclusion">Mutex (Mutual Exclusion)<a href="#mutex-mutual-exclusion" class="headerlink" title="Permalink to this heading">¶</a></h3>
<p>A <strong>Critical Section</strong> is the part of your code where multiple threads share the same data in memory. To prevent data corruption, the task of updating a critical section needs to be done uninterrupted - meaning as an <strong>atomic transaction</strong>. This ensures all other threads would read the updated value of the critical section and not stale values.</p>
<p>In programming, this is accomplished using <strong>Mutex</strong> or <strong>Mutual Exclusion</strong>. A mutex is a lock and only the thread possessing it will have access to update a shared resource / critical section. Only after the thread in possession releases a mutex, another thread can gain possession.</p>
<p>Acquiring of a mutex (the lock) is atomic, meaning it appears as an indivisible action to other threads even thought it may internally involve multiple steps. Thus no other thread can interrupt the thread acquiring the lock.</p>
<p>To rectify the previous code, we add create a mutex object using <code>threading.Lock()</code>. Then we call the <code>acquire()</code> and <code>release()</code> methods on the Mutex object appropriately when editing a shared resource. The snippet below rectifies the shopping cart code we had earlier.</p>
<div class="code"><pre class="code literal-block"><span class="kn">import</span> <span class="nn">threading</span>

<span class="n">garlic_count</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">pencil</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Lock</span><span class="p">()</span> <span class="c1"># create a Mutex</span>

<span class="k">def</span> <span class="nf">shopper</span><span class="p">(</span><span class="n">pencil</span><span class="p">):</span>
    <span class="k">global</span> <span class="n">garlic_count</span>
    <span class="n">pencil</span><span class="o">.</span><span class="n">acquire</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10_000_000</span><span class="p">):</span>
        <span class="n">garlic_count</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="n">pencil</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">'__main__'</span><span class="p">:</span>
    <span class="n">barron</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">shopper</span><span class="p">,</span> <span class="n">kwargs</span><span class="o">=</span><span class="p">{</span><span class="s1">'pencil'</span><span class="p">:</span><span class="n">pencil</span><span class="p">})</span>
    <span class="n">olivia</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">shopper</span><span class="p">,</span> <span class="n">kwargs</span><span class="o">=</span><span class="p">{</span><span class="s1">'pencil'</span><span class="p">:</span><span class="n">pencil</span><span class="p">})</span>
    <span class="n">barron</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
    <span class="n">olivia</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
    <span class="n">barron</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>
    <span class="n">olivia</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">'We should buy'</span><span class="p">,</span> <span class="n">garlic_count</span><span class="p">,</span> <span class="s1">'garlic.'</span><span class="p">)</span>
</pre></div>

<p>This has spawn two threads as earlier, but the results prints <code>20,000,000</code> correctly:</p>
<div class="code"><pre class="code literal-block"><span class="n">We</span> <span class="n">should</span> <span class="n">buy</span> <span class="mi">20000000</span> <span class="n">garlic</span><span class="o">.</span>
</pre></div>

<h4 id="locks-and-reentrant-mutex">Locks and Reentrant Mutex<a href="#locks-and-reentrant-mutex" class="headerlink" title="Permalink to this heading">¶</a></h4>
<p>What happens when a thread locks a resource, does not unlock and tries to lock again? Well, a thread cannot lock a resource if it is already locked, so it just ends up waiting for its turn to lock, which will never come. This situation is called a <strong>deadlock</strong>.</p>
<p>Deadlocks pose a major limitation when writing recursive code. A <strong>reentrant mutex</strong> solves this problem by allowing a thread to lock a resource multiple times. However, the same thread should <strong>unlock</strong> the resource the corresponding number of times to properly release it.</p>
<p>In Python, you create a reentrant lock using <code>threading.RLock()</code> <span class="caps">API</span>.  One difference between <code>Lock()</code> and <code>RLock()</code>, when a resource is locked using <code>Lock()</code>, any thread can release it. However, only the thread that locked the reentrant lock can unlock it and it needs to do as many number of times it locked originally.</p>
    </div>
    <aside class="postpromonav"><nav><ul itemprop="keywords" class="tags">
<li><a class="tag p-category" href="../../categories/parallel-processing/" rel="tag">parallel processing</a></li>
            <li><a class="tag p-category" href="../../categories/processes/" rel="tag">processes</a></li>
            <li><a class="tag p-category" href="../../categories/python/" rel="tag">python</a></li>
            <li><a class="tag p-category" href="../../categories/threads/" rel="tag">threads</a></li>
        </ul></nav></aside></article>
</div>
        <!--End of body content-->

        <footer id="footer">
            Contents © 2023         <a href="mailto:atma.mani@outlook.com">Atma Mani</a> - Powered by         <a href="https://getnikola.com" rel="nofollow">Nikola</a>         
            
        </footer>
</div>
</div>


            <script src="../../assets/js/all-nocdn.js"></script><!-- fancy dates --><script>
    moment.locale("en");
    fancydates(0, "YYYY-MM-DD HH:mm");
    </script><!-- end fancy dates --><script>
    baguetteBox.run('div#content', {
        ignoreClass: 'islink',
        captions: function(element) {
            return element.getElementsByTagName('img')[0].alt;
    }});
    </script>
</body>
</html>