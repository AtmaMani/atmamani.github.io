<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Donut or Not! - Deploying Deep Learning Inference as Serverless Functions | Atma's blog</title>
<link href="../../assets/css/all-nocdn.css" rel="stylesheet" type="text/css">
<link href="../../assets/css/ipython.min.css" rel="stylesheet" type="text/css">
<link href="../../assets/css/nikola_ipython.css" rel="stylesheet" type="text/css">
<meta name="theme-color" content="#d4567b">
<meta name="generator" content="Nikola (getnikola.com)">
<link rel="alternate" type="application/rss+xml" title="RSS" hreflang="en" href="../../rss.xml">
<link rel="canonical" href="https://atmamani.github.io/blog/deploying-deep-learning-inference-as-serverless-functions/">
<link rel="icon" href="../../scatter-16.png" sizes="16x16">
<link rel="icon" href="../../scatter-32.png" sizes="32x32">
<link rel="icon" href="../../scatter-64.png" sizes="64x64">
<link rel="icon" href="../../scatter-128.png" sizes="128x128">
<!--[if lt IE 9]><script src="../../assets/js/html5.js"></script><![endif]--><!-- Global site tag (gtag.js) - Google Analytics --><script async src="https://www.googletagmanager.com/gtag/js?id=UA-113202945-1"></script><script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-113202945-1');
</script><meta name="author" content="Atma Mani">
<link rel="prev" href="../aws-lambda-functions-with-docker-images/" title="AWS Lambda Functions - authoring with Docker images" type="text/html">
<meta property="og:site_name" content="Atma's blog">
<meta property="og:title" content="Donut or Not! - Deploying Deep Learning Inference as Serverless Functi">
<meta property="og:url" content="https://atmamani.github.io/blog/deploying-deep-learning-inference-as-serverless-functions/">
<meta property="og:description" content="There is a common myth that to perform deep learning, one needs high compute, GPU enabled devices. While this is true to a degree, when training deep learning models, it is often just as possible to p">
<meta property="og:type" content="article">
<meta property="article:published_time" content="2021-10-12T21:05:00-07:00">
<meta property="article:tag" content="aws">
<meta property="article:tag" content="cloud">
<meta property="article:tag" content="deep-learning">
<meta property="article:tag" content="fastai">
<meta property="article:tag" content="lambda">
<meta property="article:tag" content="serverless">
</head>
<body>
<a href="#content" class="sr-only sr-only-focusable">Skip to main content</a>

<!-- Menubar -->

<nav class="navbar navbar-inverse navbar-static-top"><div class="container">
<!-- This keeps the margins nice -->
        <div class="navbar-header">
            <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-navbar" aria-controls="bs-navbar" aria-expanded="false">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="https://atmamani.github.io/">

                <span id="blog-title">Atma’s blog</span>
            </a>
        </div>
<!-- /.navbar-header -->
        <div class="collapse navbar-collapse" id="bs-navbar" aria-expanded="false">
            <ul class="nav navbar-nav">
<li class="dropdown">
<a href="#" class="dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">Projects <b class="caret"></b></a>
            <ul class="dropdown-menu">
<li>
<a href="../../projects/math/">Learn math with Python</a>
                    </li>
<li>
<a href="../../projects/stats/">Learn stats with Python</a>
                    </li>
<li>
<a href="../../projects/ml/">Machine Learning projects</a>
                    </li>
<li>
<a href="../../projects/dl/">Deep Learning projects</a>
                    </li>
<li>
<a href="../../projects/spatial/">Spatial analysis</a>
                    </li>
<li>
<a href="../../projects/thermal/">Thermal remote sensing</a>
                    </li>
<li>
<a href="../../projects/mwrs/">Microwave remote sensing</a>
                    </li>
<li>
<a href="../../projects/cloud/">Cloud computing</a>
                    </li>
<li>
<a href="../../projects/fun/">Fun projects</a>
            </li>
</ul>
</li>
<li>
<a href="../">Blog</a>
                </li>
<li>
<a href="../../talks/">Talks</a>
                </li>
<li>
<a href="../../books/">Books</a>
            </li>
<li class="dropdown">
<a href="#" class="dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">Cheatsheets <b class="caret"></b></a>
            <ul class="dropdown-menu">
<li>
<a href="../../cheatsheets/learning-resources/">General learning resources</a>
                    </li>
<li>
<a href="../../"><hr></a>
                    </li>
<li>
<a href="../../cheatsheets/python/python_datatypes/">Python datatypes</a>
                    </li>
<li>
<a href="../../cheatsheets/python/python_numeric_datatypes/">Python numeric datatypes</a>
                    </li>
<li>
<a href="../../cheatsheets/python/python_conditional_execution/">Python conditional execution</a>
                    </li>
<li>
<a href="../../cheatsheets/python/python_functions/">Python functions</a>
                    </li>
<li>
<a href="../../cheatsheets/python/python_iterations/">Python iterations</a>
                    </li>
<li>
<a href="../../cheatsheets/python/python_exception_handling/">Python exception handling</a>
                    </li>
<li>
<a href="../../cheatsheets/python/python_classes/">Python classes</a>
                    </li>
<li>
<a href="../../cheatsheets/python/python_memory/">Python memory, ref counts, garbage collection</a>
                    </li>
<li>
<a href="../../cheatsheets/python/python_mutability/">Python - mutability and immutability</a>
                    </li>
<li>
<a href="../../cheatsheets/python/python_language_optimizations/">Python - language optimizations</a>
                    </li>
<li>
<a href="../../images/regex-mindmap.jpg">Python regex</a>
                    </li>
<li>
<a href="../../"><hr></a>
                    </li>
<li>
<a href="../../cheatsheets/golang/">Go introduction</a>
                    </li>
<li>
<a href="../../cheatsheets/golang/golang-basics/">Go basics</a>
                    </li>
<li>
<a href="../../cheatsheets/golang/golang-datatypes/">Go data types</a>
                    </li>
<li>
<a href="../../cheatsheets/golang/golang-control-flow/">Go control flow</a>
                    </li>
<li>
<a href="../../cheatsheets/golang/goroutine/">Goroutines - concurrency in Go lang</a>
                    </li>
<li>
<a href="../../"><hr></a>
                    </li>
<li>
<a href="../../cheatsheets/conda_cheat_sheet/">Conda basics</a>
                    </li>
<li>
<a href="../../cheatsheets/mamba_cheat_sheet/">Mamba basics</a>
                    </li>
<li>
<a href="../../"><hr></a>
                    </li>
<li>
<a href="../../cheatsheets/numpy/numpy_cheat_sheet_1/">NumPy basics</a>
                    </li>
<li>
<a href="../../cheatsheets/numpy/numpy_cheat_sheet_2/">NumPy array slicing, dicing, searching</a>
                    </li>
<li>
<a href="../../"><hr></a>
                    </li>
<li>
<a href="../../cheatsheets/pandas/pandas_cheat_sheet_1/">Pandas basics</a>
                    </li>
<li>
<a href="../../cheatsheets/pandas/pandas_cheat_sheet_2/">Pandas multilevel index, <br>    missing data, aggregation, merging</a>
                    </li>
<li>
<a href="../../cheatsheets/pandas/pandas_cheat_sheet_3/">Productivity with Pandas</a>
                    </li>
<li>
<a href="../../cheatsheets/pandas/pandas_data_viz_1/">Pandas data visualization</a>
                    </li>
<li>
<a href="../../"><hr></a>
                    </li>
<li>
<a href="../../cheatsheets/matplotlib/matplotlib_1/">Matplotlib basics</a>
                    </li>
<li>
<a href="../../cheatsheets/matplotlib/matplotlib_2/">Matplotlib log scales, ticks, scientific</a>
                    </li>
<li>
<a href="../../cheatsheets/matplotlib/matplotlib_geo/">Geographical plotting with Basemap - matplotlib toolkit</a>
                    </li>
<li>
<a href="../../"><hr></a>
                    </li>
<li>
<a href="../../cheatsheets/seaborn/seaborn_cheat_sheet_1/">Seaborn dist, joint, pair, rug plots</a>
                    </li>
<li>
<a href="../../cheatsheets/seaborn/seaborn_cheat_sheet_2/">Seaborn categorical - bar, count, <br>violin, strip, swarm plots</a>
                    </li>
<li>
<a href="../../cheatsheets/seaborn/seaborn_cheat_sheet_3/">Seaborn matrix, regression - heatmap, <br> cluster, regression</a>
                    </li>
<li>
<a href="../../cheatsheets/seaborn/seaborn_cheat_sheet_4/">Seaborn grids <span class="amp">&amp;</span> custom - pair, facet grids <br> customization</a>
                    </li>
<li>
<a href="../../"><hr></a>
                    </li>
<li>
<a href="../../cheatsheets/plotly/plotly_cufflinks_cheat_sheet_1/">Plotly introduction</a>
                    </li>
<li>
<a href="../../cheatsheets/plotly/plotly_cufflinks_cheat_sheet_2/">Plotly - interactive plotting</a>
                    </li>
<li>
<a href="../../cheatsheets/plotly/plotly_geographical_plotting_1/">Plotly - geographic plotting</a>
                    </li>
<li>
<a href="../../"><hr></a>
                    </li>
<li>
<a href="../../cheatsheets/r_cheat_sheet_1/">R basics</a>
                    </li>
<li>
<a href="../../cheatsheets/octave-1/">Octave / <span class="caps">MATLAB</span> - basics</a>
                    </li>
<li>
<a href="../../cheatsheets/octave-2/">Octave - handling data</a>
                    </li>
<li>
<a href="../../cheatsheets/js_essentials/">Javascript essentials</a>
                    </li>
<li>
<a href="../../cheatsheets/latex-1/">Latex introduction</a>
                    </li>
<li>
<a href="../../cheatsheets/docker-1/">Docker introduction</a>
                    </li>
<li>
<a href="../../cheatsheets/grep-1/">Grep introduction</a>
                    </li>
<li>
<a href="../../"><hr></a>
                    </li>
<li>
<a href="../../cheatsheets/sql/sql-1"><span class="caps">SQL</span> introduction</a>
                    </li>
<li>
<a href="../../cheatsheets/sql/sql-2"><span class="caps">SQL</span> Operators and sorting rows</a>
                    </li>
<li>
<a href="../../cheatsheets/sql/sql-3"><span class="caps">SQL</span> Joining tables</a>
                    </li>
<li>
<a href="../../cheatsheets/sql/sql-problem-sets-1"><span class="caps">SQL</span> Problem Sets</a>
                    </li>
<li>
<a href="../../"><hr></a>
                    </li>
<li>
<a href="../../cheatsheets/open-geo/geopandas-1/">GeoPandas - <span class="caps">IO</span>, projections, plotting</a>
                    </li>
<li>
<a href="../../cheatsheets/open-geo/geopandas-2/">GeoPandas - <span class="caps">GP</span>, <span class="caps">IO</span>, interactive plotting, geocoding</a>
                    </li>
<li>
<a href="../../cheatsheets/open-geo/geopandas-3/">GeoPandas - spatial overlays, topology</a>
                    </li>
<li>
<a href="../../cheatsheets/open-geo/geopandas-4/">GeoPandas - PySal, <span class="caps">OSM</span> data <span class="caps">IO</span></a>
                    </li>
<li>
<a href="../../cheatsheets/open-geo/open-geo-raster-1/">Rasterio - <span class="caps">IO</span>, plotting, histograms</a>
                    </li>
<li>
<a href="../../cheatsheets/open-geo/open-geo-raster-2/">Rasterio - hyperspectral, <span class="caps">SAM</span></a>
                    </li>
<li>
<a href="../../cheatsheets/open-geo/reading-multidim-data-using-opengeotools/">Reading multi-dimensional data using open geo tools</a>
                    </li>
<li>
<a href="../../cheatsheets/open-geo/postgis-1/">PostGIS - introduction</a>
                    </li>
<li>
<a href="../../cheatsheets/open-geo/postgis-2/">PostGIS - SQLAlchemy, GeoAlchemy, GeoPandas</a>
                    </li>
<li>
<a href="../../cheatsheets/open-geo/gdal-1/"><span class="caps">GDAL</span> - an introduction</a>
                    </li>
<li>
<a href="../../cheatsheets/open-geo/gdal-2/"><span class="caps">GDAL</span> - quickstart</a>
                    </li>
<li>
<a href="../../cheatsheets/open-geo/gdal_t1/"><span class="caps">GDAL</span> training day 1</a>
                    </li>
<li>
<a href="../../cheatsheets/open-geo/gdal_t2/"><span class="caps">GDAL</span> training day 2</a>
                    </li>
<li>
<a href="../../cheatsheets/open-geo/gdal_t3/"><span class="caps">GDAL</span> training day 3</a>
                    </li>
<li>
<a href="../../"><hr></a>
                    </li>
<li>
<a href="../../cheatsheets/web-development/">Web Development</a>
                    </li>
<li>
<a href="../../cheatsheets/html/"><span class="caps">HTML</span> basics</a>
                    </li>
<li>
<a href="../../cheatsheets/yaml_syntax/"><span class="caps">YAML</span> Syntax basics</a>
            </li>
</ul>
</li>
<li>
<a href="../../apps/">Apps</a>
                </li>
<li>
<a href="../../rss.xml"><span class="caps">RSS</span> feed</a>

                
            </li>
</ul>
<!-- DuckDuckGo custom search --><form method="get" id="search" action="https://duckduckgo.com/" class="navbar-form pull-left">
<input type="hidden" name="sites" value="https://atmamani.github.io/"><input type="hidden" name="k8" value="#444444"><input type="hidden" name="k9" value="#D51920"><input type="hidden" name="kt" value="h"><input type="text" name="q" maxlength="255" placeholder="Search…" class="span2" style="margin-top: 4px;"><input type="submit" value="DuckDuckGo Search" style="visibility: hidden;">
</form>
<!-- End of custom search -->


            <ul class="nav navbar-nav navbar-right"></ul>
</div>
<!-- /.navbar-collapse -->
    </div>
<!-- /.container -->
</nav><!-- End of Menubar --><div class="container" id="content" role="main">
    <div class="body-content">
        <!--Body content-->
        <div class="row">
            
            
<article class="post-text h-entry hentry postpage" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title" itemprop="headline name"><a href="." class="u-url">Donut or Not! - Deploying Deep Learning Inference as Serverless Functions</a></h1>

        <div class="metadata">
            <p class="byline author vcard p-author h-card"><span class="byline-name fn p-name" itemprop="author">
                    Atma Mani
            </span></p>
            <p class="dateline">
            <a href="." rel="bookmark">
            <time class="published dt-published" datetime="2021-10-12T21:05:00-07:00" itemprop="datePublished" title="2021-10-12 21:05">2021-10-12 21:05</time></a>
            </p>
            

        </div>
        

    </header><div class="e-content entry-content" itemprop="articleBody text">
    <p>There is a common myth that to perform deep learning, one needs high compute, <span class="caps">GPU</span> enabled devices. While this is true to a degree, when training deep learning models, it is often just as possible to perform inference using simple <span class="caps">CPU</span> based architectures in compute and memory constrained environments - such as serverless functions. This blog takes you through my journey of deploying a simple <strong>donut vs bagel vs vada</strong> classifier as a <span class="caps">AWS</span> Lambda function! </p>
<h4 id="checkout-the-function-at-bitlydonutornot">Checkout the function at <strong><a href="https://bit.ly/donutornot">bit.ly/donutornot</a></strong>.<a href="#checkout-the-function-at-bitlydonutornot" class="headerlink" title="Permalink to this heading">¶</a></h4>
<!--TEASER_END-->

<p>At a high-level, this application consists of a deep learning model that was trained using Fastai using a <code>resnet32</code> backbone and exported as a PyTorch model. The model is invoked by a <span class="caps">REST</span> <span class="caps">API</span> defined using FastAPI library. The whole service is packaged into a Docker image and pushed up to Amazon’s <span class="caps">AWS</span> <span class="caps">ECR</span> container registry. This is then used by a <span class="caps">AWS</span> Lambda service to create a function and exposes it using an <span class="caps">AWS</span> <span class="caps">API</span> gateway, which gives a <span class="caps">URL</span> to the service. The <span class="caps">HTML</span> front-end is created using Jinja2 templating, something that is common and well established when using micro-frameworks like Flask or FastAPI (as in this case).</p>
<p>The picture below shows the technology stack that powers this app.</p>
<p><img src="../../images/donut-or-not-tech-stack.jpg"></p>
<h4 id="how-to-guide">How to guide<a href="#how-to-guide" class="headerlink" title="Permalink to this heading">¶</a></h4>
<p>Surprisingly, the training aspects of this model was relatively simpler and predictable. However, it took a lot of reading, trial and error and experimentation to get the serverless application running. The <strong>GitHub repo at <a href="https://github.com/AtmaMani/donut_or_not">https://github.com/AtmaMani/donut_or_not</a></strong> has all the set up and deployment information. So, if that’s what you are looking for, please head there.</p>
<h4 id="things-i-learnt">Things I learnt<a href="#things-i-learnt" class="headerlink" title="Permalink to this heading">¶</a></h4>
<p>I wanted to write this blog to share my experience creating this app and also take stock of the current state of things when it comes to serverless deep learning. So, here are some observations.</p>
<ul>
<li>This project was possible because <span class="caps">AWS</span> announced support for authoring <strong>Lambda functions using Docker images</strong>. Not just any images, but they provided the exact same images they use behind the scenes. <span class="caps">AWS</span> also expanded the image size limit to <code>10GB</code>. Since the base images are slim to begin with, this large size allowance permits developers to install most of the libs needed for performing data science.</li>
<li>
<strong><span class="caps">AWS</span> <span class="caps">SAM</span> <span class="caps">CLI</span></strong> makes it possible to create a template suitable for machine learning. While it gives us a framework, I found this to be bare-bones and not sufficiently furnished for someone to get started quickly, particularly for someone who is not a cloud engineer.</li>
<li>It took me multiple attempts to figure out how to get the dependencies successfully install on the image. I finally settled with an approach of specifying certain deps in the <code>requirements.txt</code> and certain others to install directly via <code>Docker RUN</code> command. This seems approach seems fragile to me.</li>
<li>Once the dependencies were installed, it took several attempts to get the FastAPI service run via Docker. I had problems understanding how to codify my endpoints in <span class="caps">SAM</span>’s <code>template.yml</code> file. Since my app allows users to upload a <span class="caps">JPG</span> (a binary file), I had to read through several StackExchange comments and <span class="caps">SAM</span>’s GitHub issues to figure out how to specify the <span class="caps">MIME</span> type. It appeared quirky and I would have liked this supported out-of-the-box, as it is with Heroku.</li>
<li>Once the FastAPI service started running, I ran into a few permission denial issues. Apparently, Lambda runs the container with a user with minimal privileges, unlike the local runtime emulator. Thus, I ended up with new errors that crop up in production, but not in local dev env.</li>
</ul>
<p>However, this was a great learning experience and now I have a template to follow, if I were to deploy additional models to production. I have a method to perform deep learning inference via a low-cost, low-maintenance, on-demand manner using serverless cloud infrastructure.</p>
<p>I hope this blog and GitHub repo is useful for others who are attempting to do the same.</p>
    </div>
    <aside class="postpromonav"><nav><ul itemprop="keywords" class="tags">
<li><a class="tag p-category" href="../../categories/aws/" rel="tag">aws</a></li>
            <li><a class="tag p-category" href="../../categories/cloud/" rel="tag">cloud</a></li>
            <li><a class="tag p-category" href="../../categories/deep-learning/" rel="tag">deep-learning</a></li>
            <li><a class="tag p-category" href="../../categories/fastai/" rel="tag">fastai</a></li>
            <li><a class="tag p-category" href="../../categories/lambda/" rel="tag">lambda</a></li>
            <li><a class="tag p-category" href="../../categories/serverless/" rel="tag">serverless</a></li>
        </ul>
<ul class="pager hidden-print">
<li class="previous">
                <a href="../aws-lambda-functions-with-docker-images/" rel="prev" title="AWS Lambda Functions - authoring with Docker images">Previous post</a>
            </li>
        </ul></nav></aside></article>
</div>
        <!--End of body content-->

        <footer id="footer">
            Contents © 2023         <a href="mailto:atma.mani@outlook.com">Atma Mani</a> - Powered by         <a href="https://getnikola.com" rel="nofollow">Nikola</a>         
            
        </footer>
</div>
</div>


            <script src="../../assets/js/all-nocdn.js"></script><!-- fancy dates --><script>
    moment.locale("en");
    fancydates(0, "YYYY-MM-DD HH:mm");
    </script><!-- end fancy dates --><script>
    baguetteBox.run('div#content', {
        ignoreClass: 'islink',
        captions: function(element) {
            return element.getElementsByTagName('img')[0].alt;
    }});
    </script>
</body>
</html>